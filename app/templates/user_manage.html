<!DOCTYPE html>
<html lang="ko">
<head>  
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preload stylesheet" as="style" href="https://fonts.googleapis.com/css2?family=Gothic+A1:wght@200&family=Nanum+Gothic&family=Nanum+Myeongjo&family=Noto+Sans+KR:wght@400&family=Roboto:wght@100&display=swap">    
  <title>우보 유저관리</title>

  <style>
    @import url('https://fonts.googleapis.com/css?family=Lato:400,700');
    @import url('https://fonts.googleapis.com/css?family=Do+Hyeon:400');

    @font-face {
      font-family: 'NanumGothic';
      font-style: normal;
      src: url("/fonts/Nanum_Gothic/NanumGothic-Regular.ttf");
    }

    *,
    *:before, 
    *:after {
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: #f0f0f0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }

    .profile-box {
      width: 100%;
      max-width: 430px;
      background-color: #fff;
      border-radius: 15px;
      border: 2px solid #eee;
      box-shadow: 0 14px 28px rgba(0, 0, 0, 0.25),
                  0 10px 10px rgba(0, 0, 0, 0.22);
      padding: 25px;
      text-align: center;
      max-height: 90vh;
      overflow-y: auto;  /* 컨텐츠가 넘칠 경우 스크롤 추가 */
      margin: 20px;      /* 모바일에서 여백 추가 */
    }

    h1 {
      font-family: 'Do Hyeon', sans-serif;
      font-size: 1.8em;
      margin-bottom: 5px;
      color: #333;
    }

    .meta {
      color: #777;
      font-size: 0.9em;
      margin: 0px;
    }

    h2 {
      margin-top: 15px;
      margin-bottom: 0px;
      font-size: 1.3em;
      border-bottom: 2px solid #eee;
      padding-bottom: 5px;
      color: #444;
    }


    .room-title {
    position: sticky;    /* 스크롤 시 고정 */
    top: 0;              /* room-block 내부 상단 기준 */
    background-color: #fff; /* 배경색 필수, 투명이면 내용 겹침 */
    padding: 5px 0;
    font-size: 1.1em;
    color: #555;
    z-index: 1;          /* 다른 요소 위로 */
    margin-bottom: 5px;
    margin-top: 0px;
    display: flex;
    justify-content: flex-start; /* 왼쪽 정렬 */
    align-items: center;
    gap: 10px;
    }

    .join-btn {
    font-size: 0.9em;
    padding: 3px 8px;
    background-color: #dfdfdf;
    color: #3f5cff;
    text-decoration: none;
    border-radius: 5px;
    font-weight: bold;
    }

    .join-btn:hover {
    background-color: #acacac;
    }
    .user-list {
      max-height: 200px;
      text-align: left;
      overflow-y: auto;
    }
    .user-list ul, .mission-list ul {
      list-style-type: none; 
      padding-left: 0;       
      margin: 0;              
    }

    .user-info {
      background-color: #fafafa;
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 10px;
      text-align: left;
      margin-top: 10px;
    }

    .mission-list {
      max-height: 200px;
      text-align: left;
      overflow-y: auto;
    }
    .mission-info {
      background-color: #fafafa;
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 10px;
      text-align: left;
      margin-top: 10px;
    }

    .mission b {
      color: #333;
    }


    p {
      color: #666;
    }

		.modal {
  		font-family: 'NanumGothic';
  		position: fixed;
  		top: 45%;
  		left: 50%;
  		transform: translate(-50%, -50%);
  		background-color: white;
  		border: 1px solid #ccc;
  		padding: 20px;
  		box-shadow: 0 0 10px rgba(0,0,0,0.3);
  		z-index: 1000;
  		border-radius: 5px;
  		width: 400px; /* 적당한 너비 지정 */
  		display: flex;
  		flex-direction: column;
		}

		.modal-overlay {
  		display: none;
  		position: fixed;
  		top: 0; left: 0;
  		width: 100vw; height: 100vh;
  		background: rgba(0, 0, 0, 0.5);
  		justify-content: center;
  		align-items: center;
  		z-index: 1000;
		}
        
		.modal-header {
  		display: flex;
  		justify-content: space-between;
  		align-items: center;
  		margin-bottom: 15px;
		}

		.modal-header h2 {
  		margin: 0;
		}        
        
    #toggleSettingsBtn {
  		padding: 5px 12px;
  		cursor: pointer;
		}
        
    .modal-footer {
      margin-top: 15px;
      padding: 5px 10px;
      background: white;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

		.modal-footer button {
      padding: 6px 12px;
      cursor: pointer;
      margin-top: 8px;
      margin-bottom: 8px;
      width: fit-content;
		}
    
    #approveUserList {
      width: 100%;
      text-align: left;
    }
  </style>
</head>

<body>
  <div class="profile-box">
    <h1>{{ user.username }}</h1>
    <p class="meta">가입일: {{ user.created_at.strftime('%Y-%m-%d') }}</p>
    <a href="{{ url_for('chat_app', room_name=user.username) }}" class="join-btn">채팅방 접속</a>

    <h2>
      유저 목록
      <button onclick="openModal('modal1')">승인 요청</button>
    </h2>
    <div class="user-list">
      <ul>
        {% for u in chat_room.users %}
          <li class="user-info">
            <b>이름:</b> {{ u.username }}<br>
            <b>포인트:</b> {{ u.point }}
          </li>
        {% endfor %}
      </ul>

    {% if not chat_room.users %}
      <p>아직 유저가 없습니다.</p>
    {% endif %}
  </div>

  <h2>과제 목록</h2>
    <div class="room-block">
      <div class="mission-list">
        <ul>
          {% if chat_room.missions %}
            {% for p in chat_room.missions %}
              <div class="mission-info">
                <b>내용:</b> {{ p.content }}<br>
                <b>점수:</b> {{ p.reward }}
              </div>
            {% endfor %}
          {% else %}
            <p>아직 과제가 없습니다.</p>
          {% endif %}
        </ul>
      </div>
    </div>

    <div class="modal-overlay" id="modal1" onclick="handleOverlayClick(event, 'modal1')">
        <div class="modal">
            <h3 class="modal-header">승인 요청 목록</h3>
            <div id="approveUserList"></div>
            <div class="modal-footer">
                <button class="close-btn" onclick="closeModal('modal1')">닫기</button>
            </div>
        </div>
    </div>    
  </div>
  <script>
    function openModal(id) {
      document.getElementById(id).style.display = "flex";
        if (id === "modal1") {
            loadApproveUserList();
        }
    }

    function closeModal(id) {
      document.getElementById(id).style.display = "none";
          currentEditItem = null;
    }

    function handleOverlayClick(event, modalId) {//배경을 클릭했을 때 화면 닫기
        if (event.target === event.currentTarget) {
          closeModal(modalId);
        }
    }    
    function loadApproveUserList() { // 로그인한 사람이 admin일때 모달이 뜨게해서 모달이 뜬사람의 로그인정보 활용한거임
        const adminUsername = "{{ username }}";
        const approveUserListDiv = document.getElementById('approveUserList');
        approveUserListDiv.innerHTML = ''; // 기존 버튼 제거

        fetch(`/get_approve_users?admin=${encodeURIComponent(adminUsername)}`)
            .then(res => res.json())
            .then(users => {
                if (users.length === 0) {
                    approveUserListDiv.innerHTML = '<p>승인 요청이 없습니다.</p>';
                    return;
                }
                users.forEach(user => {
                    const btn = document.createElement("button");
                    btn.textContent = user.username;
                    btn.onclick = async () => {
                        const admin = "{{ username }}"; // 현재 로그인한 관리자 이름(채팅방 이름)
                        const res = await fetch("/approve_user", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ username: user.username, admin }) // username과 admin 전달
                        });
                        const data = await res.json();
                        if (data.success) {
                            alert(`${user.username} 승인 완료`);
                            loadApproveUserList(); // 목록 새로고침
                        } else {
                            alert("승인 실패");
                        }
                    };
                    approveUserListDiv.appendChild(btn);
                });
            });
    }
  </script>
</body>

</html>