<!DOCTYPE html>
<html lang="ko">
<head>  
  <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>  
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preload stylesheet" as="style" href="https://fonts.googleapis.com/css2?family=Gothic+A1:wght@200&family=Nanum+Gothic&family=Nanum+Myeongjo&family=Noto+Sans+KR:wght@400&family=Roboto:wght@100&display=swap">    
  <title>우보 유저관리</title>

  <style>
    @import url('https://fonts.googleapis.com/css?family=Lato:400,700');
    @import url('https://fonts.googleapis.com/css?family=Do+Hyeon:400');

    @font-face {
      font-family: 'NanumGothic';
      font-style: normal;
      src: url("/fonts/Nanum_Gothic/NanumGothic-Regular.ttf");
    }

    *,
    *:before, 
    *:after {
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: #f0f0f0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }

    .profile-box {
      width: 100%;
      max-width: 430px;
      background-color: #fff;
      border-radius: 15px;
      border: 2px solid #eee;
      box-shadow: 0 14px 28px rgba(0, 0, 0, 0.25),
                  0 10px 10px rgba(0, 0, 0, 0.22);
      padding: 25px;
      text-align: center;
      max-height: 90vh;
      overflow-y: auto;  /* 컨텐츠가 넘칠 경우 스크롤 추가 */
      margin: 20px;      /* 모바일에서 여백 추가 */
    }

    h1 {
      font-family: 'Do Hyeon', sans-serif;
      font-size: 1.8em;
      margin-bottom: 5px;
      color: #333;
    }

    .meta {
      color: #777;
      font-size: 0.9em;
      margin: 0px;
    }

    h2 {
      margin-top: 15px;
      margin-bottom: 0px;
      font-size: 1.3em;
      border-bottom: 2px solid #eee;
      padding-bottom: 5px;
      color: #444;
    }


    .room-title {
    position: sticky;    /* 스크롤 시 고정 */
    top: 0;              /* room-block 내부 상단 기준 */
    background-color: #fff; /* 배경색 필수, 투명이면 내용 겹침 */
    padding: 5px 0;
    font-size: 1.1em;
    color: #555;
    z-index: 1;          /* 다른 요소 위로 */
    margin-bottom: 5px;
    margin-top: 0px;
    display: flex;
    justify-content: flex-start; /* 왼쪽 정렬 */
    align-items: center;
    gap: 10px;
    }

    .join-btn {
    font-size: 0.9em;
    padding: 3px 8px;
    background-color: #dfdfdf;
    color: #3f5cff;
    text-decoration: none;
    border-radius: 5px;
    font-weight: bold;
    }

    .join-btn:hover {
    background-color: #acacac;
    }
    .user-list, .mission-list {
      max-height: 200px;
      text-align: left;
      overflow-y: auto;
    }
    .user-list ul, .mission-list ul, #ui_praises {
      list-style-type: none; 
      padding-left: 0;       
      margin: 0;              
    }

    .user-info, .mission-info, .praise-item {
      background-color: #fafafa;
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 10px;
      text-align: left;
      margin-top: 10px;
    }

    .character-list {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
      max-height: 170px;
      overflow: auto;
    }

    .character-list img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 10px;
      border: 1px solid #ddd;
      transition: transform 0.2s;
    }

    .character-list img:hover {
      transform: scale(1.1);
    }


    .user-info:hover, .mission-info:hover {
      background-color: #f0f0f0;
    } 

    .mission b {
      color: #333;
    }


    p {
      color: #303030;
    }

		.modal {
  		font-family: 'NanumGothic';
  		position: fixed;
  		top: 45%;
  		left: 50%;
  		transform: translate(-50%, -50%);
  		background-color: white;
  		border: 1px solid #ccc;
  		padding: 20px;
  		box-shadow: 0 0 10px rgba(0,0,0,0.3);
  		z-index: 1000;
  		border-radius: 5px;
  		width: 400px; /* 적당한 너비 지정 */
  		display: flex;
  		flex-direction: column;
		}

		.modal-overlay {
  		display: none;
  		position: fixed;
  		top: 0; left: 0;
  		width: 100vw; height: 100vh;
  		background: rgba(0, 0, 0, 0.5);
  		justify-content: center;
  		align-items: center;
  		z-index: 1000;
		}
        
		.modal-header {
  		display: flex;
  		justify-content: space-between;
  		align-items: center;
  		margin-bottom: 15px;
		}

		.modal-header h2 {
  		margin: 0;
		}        
        
    #toggleSettingsBtn {
  		padding: 5px 12px;
  		cursor: pointer;
		}
        
    .modal-footer {
      margin-top: auto;
      padding: 5px 10px;
      background: white;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

		.modal-footer button {
      padding: 6px 12px;
      cursor: pointer;
      margin-top: 8px;
      margin-bottom: 8px;
      width: fit-content;
		}
    
    #approveUserList {
      width: 100%;
      text-align: left;
    }

    .delete-btn {
    color: red;
    border: 2px solid red;
    }  

    .give-point-btn {
    color: rgb(52, 144, 248);
    border: 2px solid rgb(0, 113, 241);
    }


    /* 미션모달 스타일 */
    /* 큰 모달 */
    .large-modal {
      width: 80vw;      /* 화면 가로 80% */
      height: 80vh;     /* 화면 세로 80% */
    }

    /* 모달 바디 */
    .mission-modal-content {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    /* 미션 내용 */
    .mission-info {
      margin-bottom: 10px;
    }

    /* 체크리스트와 체크한 사람 순서를 좌우로 배치 */
    .mission-body {
      display: flex;
      flex-direction: row;
      gap: 20px;
      position: relative;
      flex: 1;
    }

    /* 왼쪽 체크리스트 */


    #userChecklist {
      display: flex;          /* 버튼들을 가로로 배치 */
      flex-wrap: wrap;        /* 공간 부족하면 다음 줄로 자동 줄바꿈 */
      gap: 8px;               /* 버튼 사이 간격 */
      flex: 1;             /* 왼쪽 영역 남은 공간 차지 */
    }
    #userChecklist .user-check {  /* div.user-check */
      display: inline-flex;        /* 버튼을 가로로 유지 */
    }
    /* 체크 버튼 스타일 */
    button.user-check {
      flex: 0 1 auto;         /* 필요에 따라 줄바꿈 허용 */
      padding: 6px 12px;
      border: 1px solid #ccc;
      border-radius: 5px;
      cursor: pointer;
      background-color: #f0f0f0;
      font-size: 14px;
      white-space: normal;    /* 길어지면 줄바꿈 */
      text-align: center;
      width: 150px;
      height: 100px;
      display: flex;          /* 플렉스 박스로 변경 */
      justify-content: center; /* 수평 중앙 정렬 */
      align-items: center;  
    }

    button.user-check.checked {
      background-color: #bbd4fa;      /* 체크된 상태 색상 */
      border-color: #99bff8;
    }
    /* 오른쪽 체크한 사람 목록 */
    .checked-list {
      position: absolute;
      right: 0;             /* 오른쪽 끝 고정 */
      width: 25%;          /* 원하는 고정 너비 */
      border-left: 1px solid #eee;
      padding-left: 15px;
      flex: none;
    }

    .checked-list ol {
      padding-left: 20px;
      margin: 0;
    }    
  </style>
</head>

<body>
  <div class="profile-box">
    <h1>{{ user.username }}</h1>
    <p class="meta">가입일: {{ user.created_at.strftime('%Y-%m-%d') }}</p>
    <a href="{{ url_for('chat_app', room_name=user.username) }}" class="join-btn">채팅방 접속</a>

    <h2>
      유저 목록
      <button onclick="openModal('modal1')">승인 요청</button>
    </h2>
    <div class="user-list">
      <ul>
        {% for u in chat_room.users %}
          {% if u.approved %}
            <li class="user-info"
                data-username="{{ u.username }}"
                data-point="{{ u.point }}"
                onclick="openUserModal('modal2', this)">
              <b>이름:</b> {{ u.username }}<br>
              <b>포인트:</b> {{ u.point }}
            </li>
          {% endif %}
        {% endfor %}
      </ul>

    {% if not chat_room.users %}
      <p>아직 유저가 없습니다.</p>
    {% endif %}
  </div>

  <h2>과제 목록</h2>
  <div class="room-block">
    <div class="mission-list">
      <ul>
        {% for p in chat_room.missions %}
          <li class="mission-info"
              onclick="openMissionModal('{{ p._id }}')">
            <b>내용:</b> {{ p.content }}<br>
            <b>점수:</b> {{ p.reward }}
          </li>
        {% endfor %}
      </ul>
    {% if not chat_room.missions %}
      <p>아직 과제가 없습니다.</p>
    {% endif %}     
    </div>
  </div>

  <div class="modal-overlay" id="modal1" onclick="handleOverlayClick(event, 'modal1')">
      <div class="modal">
          <h3 class="modal-header">승인 요청 목록</h3>
          <div id="approveUserList"></div>
          <div class="modal-footer">
              <button class="close-btn" onclick="closeModal('modal1')">닫기</button>
          </div>
      </div>
  </div>    

  <div class="modal-overlay" id="modal2" onclick="handleOverlayClick(event, 'modal2')">
    <div class="modal">
      <h3 class="modal-header">유저 정보</h3>
      <div id="userModalContent">
        <p><b id="ui_username">-</b></p>
        <p>현재 포인트: <span id="ui_point">0</span>점</p>
        <h4>도감 목록</h4>
        <div class="character-list" id="ui_characters">
          <p>아직 획득한 캐릭터가 없습니다.</p>
        </div>
        <h4>받은 칭찬</h4>
        <ul id="ui_praises" style="max-height:160px; overflow:auto; padding-left:16px;"></ul>
      </div>
      <div class="modal-footer">
        <button class="delete-btn" onclick="deleteUser()">유저 삭제</button>
        <button class="close-btn" onclick="closeModal('modal2')">닫기</button>
      </div>
    </div>
  </div>



  <div class="modal-overlay" id="modal3" onclick="handleOverlayClick(event, 'modal3')">
    <div class="modal large-modal">
      <h3 class="modal-header">과제 정보</h3>
      <div id="missionModalContent" class="mission-modal-content">
        <!-- 미션 정보 -->
        <div class="mission-info">
          <p>내용: <b id="ui_mission">-</b></p>
          <p>점수: <span id="ui_reward">0</span>점</p>
        </div>

        <!-- 체크리스트 + 체크한 사람 순서 -->
        <div class="mission-body">
          <!-- 왼쪽: 체크리스트 -->
          <div class="checklist" id="userChecklist">
            <!-- 버튼식 체크리스트가 여기 들어감 -->
          </div>

          <!-- 오른쪽: 체크한 사람 순서 -->
          <div class="checked-list">
            <p>체크한 사람:</p>
            <ol id="checkedUsersList"></ol>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="give-point-btn" onclick="givePoints()">점수 지급</button>
        <button class="close-btn" onclick="closeModal('modal3')">닫기</button>
      </div>
    </div>
  </div>
 
  <script>
    // 모달에서 현재 열려 있는 미션 ID를 전역 변수로 저장
    let currentMissionId = null;

    (function() {
        const socket = io();

        // 연결 상태 확인
        console.log("Socket connected?", socket.connected);

        //체크 업데이트 시 새로고침
        socket.on("mission_checked_update", data => {
          if (currentMissionId === data.mission_id) {
              refreshCheckedUsersList(currentMissionId);
          }
        });

        socket.on("connect", () => {
            const username = "{{ username }}";
            console.log("Socket connected! ID:", socket.id, "username:", username);
            socket.emit("join", { 'room_name': `admin_${username}` });
        });

        socket.on("disconnect", () => {
            console.log("Socket disconnected");
        });
        
    })();

    async function openUserModal(modal, element) {
      const username = element.dataset.username;
      const point = element.dataset.point;
      const room_name = "{{ chat_room.name }}";
      document.getElementById('ui_username').textContent = username;
      document.getElementById('ui_point').textContent = point;

      openModal(modal);

      try {
        const res = await fetch('/get_user_detail', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, room_name })
        });

        const data = await res.json();

        if (data.success) {
          const charList = document.getElementById('ui_characters');
          charList.innerHTML = '';
          // 도감 목록 채우기
          if (data.characters && data.characters.length > 0) {
            data.characters.forEach(ch => {
              const img = document.createElement('img');
              img.src = `/static/characters/${ch}`; // ✅ Flask static 경로와 동일하게
              img.alt = ch;
              charList.appendChild(img);
            });
          } else {
            const p = document.createElement('p');
            p.textContent = '아직 획득한 캐릭터가 없습니다.';
            charList.appendChild(p);
          }

          // 칭찬 목록 채우기
          const praiseList = document.getElementById('ui_praises');
          praiseList.innerHTML = '';
          if (data.praises && data.praises.length > 0) {
            data.praises.forEach(p => {
              const li = document.createElement('li');
              li.classList.add('praise-item');
              li.innerHTML = `<b>${p.content}</b> (+${p.point}점)`; // ✅ content와 point 표시
              praiseList.appendChild(li);
            });
          } else {
            // ✅ 칭찬이 없을 때 기본 메시지
            const li = document.createElement('li');
            li.textContent = '받은 칭찬이 없습니다.';
            praiseList.appendChild(li);
          }
        } else {
          console.error('유저 정보 불러오기 실패:', data.message);
        }
      } catch (err) {
        console.error('요청 중 오류 발생:', err);
      }
    }

    async function openMissionModal(missionId) {
      currentMissionId = missionId; // 지금 열려 있는 미션의 ID 저장
      try {
        // 1️⃣ 미션 정보 가져오기
        const missionRes = await fetch(`/get_mission_detail/${missionId}`);
        const missionData = await missionRes.json();
        if (!missionData.success) {
          alert("미션 정보를 불러오지 못했습니다.");
          return;
        }

        const mission = missionData.mission;
        const users = missionData.users;

        // 3️⃣ 모달에 데이터 표시
        document.getElementById("ui_mission").textContent = mission.content;
        document.getElementById("ui_reward").textContent = mission.reward;

        const checklist = document.getElementById("userChecklist");
        checklist.innerHTML = ""; // 초기화 

        openModal('modal3');

        //모달 열었을 때 체크리스트 표시
        users.forEach(u => {
            const username = u;
            const checked = mission.checked && mission.checked.includes(username);

            const btn = document.createElement("button");
            btn.classList.add("user-check");
            btn.innerHTML = (checked ? "✔️ " : "") + username;
            if (checked) btn.classList.add("checked"); // 이미 체크된 상태 표시

            // 클릭 이벤트
            btn.addEventListener("click", () => {
                const isChecked = btn.classList.toggle("checked"); // 클래스 토글
                btn.innerHTML = (checked ? "✔️ " : "") + username;
                
                toggleMissionCheck(mission._id, username, isChecked); // 서버에 체크/체크해제 전송
            });

          checklist.appendChild(btn);

        }); 

        //모달 열 때 체크한 사람 리스트 가져옴
        refreshCheckedUsersList(mission._id);        
      } catch (err) {
        console.error("미션 모달 로딩 실패:", err);
      }     
      }

    //missions에 check여부 업데이트 함
    async function toggleMissionCheck(missionId, username, isChecked) {
      const admin = "{{ chat_room.admin_name }}";

      //기존 백엔드 함수 사용
      const res = await fetch("/update_checked", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          mission_id: missionId,
          username: username,
          admin: admin,
          checked: isChecked
        })
      });

      const data = await res.json();
      if (!data.success) {
        alert("업데이트 실패: " + data.message);
        checkbox.checked = !checked;
      }
      // 체크한 사람 목록 갱신
      refreshCheckedUsersList(missionId);
    }

    function givePoints() {
      fetch('/give_mission_points', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          name: "{{ username }}",
          mission_id: currentMissionId
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          loadUsers();
          renderMissions(data.missions);
          closeModal('modal3');
          alert(data.message);
        } else {
          alert("오류: " + data.message);
        }
      });
    }

    async function refreshCheckedUsersList(missionId) {
      try {
        const res = await fetch(`/get_mission_detail/${missionId}`);
        const data = await res.json();

        if (!data.success) return;

        const mission = data.mission;
        const checkedUsers = mission.checked || []; // 서버에서 체크 순서대로 가져옴
        const checkedList = document.getElementById("checkedUsersList");
        const checklist = document.getElementById("userChecklist");

        // 1️⃣ 체크한 사람 목록 갱신
        checkedList.innerHTML = ""; // 초기화

        checkedUsers.forEach((username, index) => {
          const li = document.createElement("li");
          li.textContent = username;
          checkedList.appendChild(li);
        });


        // 2️⃣ 체크박스 리스트 갱신
        checklist.innerHTML = ""; // 초기화
        const users = data.users; // 승인된 유저 리스트
        users.forEach(u => {
            const username = u;
            const checked = mission.checked && mission.checked.includes(username);

            const btn = document.createElement("button");
            btn.classList.add("user-check");
            btn.innerHTML = (checked ? "✔️ " : "") + username;
            if (checked) btn.classList.add("checked"); // 이미 체크된 상태 표시

            // 클릭 이벤트
            btn.addEventListener("click", () => {
                const isChecked = btn.classList.toggle("checked"); // 클래스 토글
                btn.innerHTML = (checked ? "✔️ " : "") + username;
                
                toggleMissionCheck(mission._id, username, isChecked); // 서버에 체크/체크해제 전송
            });

          checklist.appendChild(btn);
          
        });

      } catch (err) {
        console.error("체크리스트 갱신 실패:", err);
      }
    }

    function renderMissions(missions) {
      const missionList = document.querySelector('.mission-list ul');
      missionList.innerHTML = '';

      if (missions && missions.length > 0) {
        missions.forEach(m => {
          const li = document.createElement('li');
          li.className = 'mission-info';
          li.innerHTML = `<b>내용:</b> ${m.content}<br><b>점수:</b> ${m.reward}`;
          li.onclick = () => openMissionModal(m._id);
          missionList.appendChild(li);
        });
      } else {
        missionList.innerHTML = '<p>아직 과제가 없습니다.</p>';
      }
    }    

    function openModal(id) {
      document.getElementById(id).style.display = "flex";
        if (id === "modal1") {
            loadApproveUserList();
        }
    }

    function closeModal(id) {
      document.getElementById(id).style.display = "none";
          currentMissionId = null;
    }

    function handleOverlayClick(event, modalId) {//배경을 클릭했을 때 화면 닫기
        if (event.target === event.currentTarget) {
          closeModal(modalId);
        }
    }    
    function loadApproveUserList() { // 로그인한 사람이 admin일때 모달이 뜨게해서 모달이 뜬사람의 로그인정보 활용한거임
        const adminUsername = "{{ username }}";
        const approveUserListDiv = document.getElementById('approveUserList');
        approveUserListDiv.innerHTML = ''; // 기존 버튼 제거

        fetch(`/get_approve_users?admin=${encodeURIComponent(adminUsername)}`)
            .then(res => res.json())
            .then(users => {
                if (users.length === 0) {
                    approveUserListDiv.innerHTML = '<p>승인 요청이 없습니다.</p>';
                    return;
                }
                users.forEach(user => {
                    const btn = document.createElement("button");
                    btn.textContent = user.username;
                    btn.onclick = async () => {
                        const admin = "{{ username }}"; // 현재 로그인한 관리자 이름(채팅방 이름)
                        const res = await fetch("/approve_user", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ username: user.username, admin }) // username과 admin 전달
                        });
                        const data = await res.json();
                        if (data.success) {
                            alert(`${user.username} 승인 완료`);
                            loadApproveUserList(); // 목록 새로고침
                        } else {
                            alert("승인 실패");
                        }
                    };
                    approveUserListDiv.appendChild(btn);
                });
            });
    }

    function loadUsers() {
      fetch('/get_users')
        .then(res => res.json())
        .then(users => { // ✅ 리스트 직접 받음
          const userList = document.querySelector('.user-list ul');
          userList.innerHTML = ''; // 기존 목록 초기화

          if (!users || users.length === 0) {
            // 유저가 없을 때 메시지 표시
            document.querySelector('.user-list').innerHTML = '<p>아직 유저가 없습니다.</p>';
            return;
          }

          users.forEach(user => {
            const li = document.createElement('li');
            li.className = 'user-info';
            li.dataset.username = user.username;
            li.dataset.point = user.point;

            li.innerHTML = `
              <b>이름:</b> ${user.username}<br>
              <b>포인트:</b> ${user.point}
            `;

            // 유저 클릭 시 모달 열기
            li.onclick = function () {
              openUserModal('modal2', li);
            };

            userList.appendChild(li);
          });
        })
        .catch(err => console.error('Error:', err));
    }

    function deleteUser() {
      const target_user = document.getElementById('ui_username').textContent.trim(); // 현재 모달에 표시된 유저 이름

      if (!target_user) {
        alert('유저 이름을 찾을 수 없습니다.');
        return;
      }

      if (!confirm(`${target_user} 님을 삭제하시겠습니까?`)) return;

      fetch('/user_delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ target_user })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert(`${target_user} 유저가 삭제되었습니다.`);
          closeModal('modal2');
          // 유저 목록 새로고침
          loadUsers(); 
        } else {
          alert(`삭제 실패: ${data.message}`);
        }
      })
      .catch(err => console.error('Error:', err));
    }
  </script>
</body>

</html>