<!DOCTYPE html> 
<html lang="en">  
  
<head>  
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preload stylesheet" as="style" href='https://fonts.googleapis.com/css2?family=Gothic+A1:wght@200&family=Nanum+Gothic&family=Nanum+Myeongjo&family=Noto+Sans+KR:wght@400&family=Roboto:wght@100&display=swap'>    
    <title>ìš°  ë³´</title>
    <style>/*í—¤ë“œì˜ ìŠ¤íƒ€ì¼ì€ ì‚¬ìš©í•  ìš”ì†Œë“¤ì˜ ìŠ¤íƒ€ì¼ë§Œ ì§€ì •í•¨ ì»¨í…Œì´ë„ˆë°•ìŠ¤ ì•ˆì—ì„œ ì¶”ê°€ëœë‹¤ë©´ ì–´ë””ì„œ ì¶”ê°€ë ì§€ ì´ë¯¸ì§€ë¡œë§Œ ì„¤ì •í•¨ ìŠ¤í¬ë¦½íŠ¸ì™€ í˜¸í™˜ì€ x í°íŠ¸ë‚˜ ìœ„ì¹˜, ì—ë‹ˆë©”ì´ì…˜ ì •ë„ë¡œë§Œ ì„¤ì • ë‚˜ì¤‘ì— jsì—ì„œ ê¸°ëŠ¥ ì¶”ê°€í•  ë•Œ ê³ ë ¤í•´ì„œ noneì •ë„ë§Œ ë‹¨ìˆœ ë””ìì¸ë§Œ ì„¤ì •í•¨*/
        @import url('https://fonts.googleapis.com/css?family=Lato:400,700');
        @import url('https://fonts.googleapis.com/css?family=Do+Hyeon:400');

        @font-face {
            font-family: 'NanumGothic';
            font-style: normal;
            src: url("/static/fonts/NanumGothic-Regular.ttf");
        }

        *,
        *:before, 
        *:after {
            box-sizing: border-box;/*ëª¨ë“  ìš”ì†Œë¥¼ width heightë¡œ ë„ˆë¹„, ë†’ì´ íŒ¨ë”©, ë³´ë” ìë™ìœ¼ë¡œ ì„¤ì •í•´ì¤Œ*/
        }
        p {
  		font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  		font-size: 16px;
  		color: #333;
 		margin: 2px;
		}

        ul {
            margin: 0;
            padding: 15px 15px 0 15px;
        }

        html,body {
            height: 100%;
            width: 100%;
            display: flex;/*í”Œë ‰ìŠ¤ ë°•ìŠ¤ ë ˆì´ì•„ì›ƒ*/
            justify-content: center;
            align-items: center;
        }

        .container {
            margin: 0 auto;
            border-radius: 5px;
            display: flex;
            justify-content: center;            
            width: 100%;
        }

        .chat {
            width: 100%;
            color: #434651;            
            border: 2px solid #EEEEEE  ;
            max-width: 430px;
            margin: 0 auto;

            border-radius: 15px;
            background-color: white;
            box-shadow: 0 14px 28px rgba(0, 0, 0, 0.25), 0 10px 10px rgba(0, 0, 0, 0.22);
        }

        .chat .chat-header {
            display: flex;
            padding: 5px 0 7px 0;
            border-bottom: 4px solid white;
            align-items: center;
            justify-content: center;
            background-color:#F4F4F4;
        }
        
        .chat .chat-header .chat-about {
            margin-left: 20px;
            margin-right: 20px;
            font-size: 35px;            
            font-family: 'Do Hyeon';
            text-align: center;
        }
        
        .chat .chat-history {
            padding: 10px 0px 10px 0px;
            border-bottom: 5px solid white;
            scrollbar-width: none;/*íŒŒì´ì–´í­ìŠ¤ ìŠ¤í¬ë¡¤ë°” ì•ˆë³´ì´ê²Œ ì„¤ì •*/
            overflow-y: auto; /* ìŠ¤í¬ë¡¤ë°” ì„¤ì • ìë™ */
            height: 575px;
        }

        /* Chrome, Safari, Edge */
        .chat .chat-history::-webkit-scrollbar {
            display: none;
        }

        .chat .chat-history .message-data {
            margin-bottom: 15px;
            font-size: 14px;
        }

        .chat .chat-history .message-data-time {
            font-size: 14px;
        }

        .chat .chat-history .message {
            color: white;
            padding: 18px 20px;
            line-height: 22px;
            border-radius: 15px;
            margin-bottom: 15px;
            width: 100%;
            position: relative;/*afterì˜ ì ˆëŒ€ì  ê¸°ì¤€ì ì´ ë¼ì„œ after ì ìš©í•  ìˆ˜ ìˆê²Œ í•¨*/
        }

        .chat .chat-history .message:after {/*my-messageëŠ” ì—¬ê¸°ì„œ ì„¤ì •í•œ ê¸°ë³¸ ì„¤ì •ì„ ë”°ë¦„*/
            bottom: 100%;
            border: solid transparent;
            content: " ";
            height: 0;
            width: 0;
            position: absolute;
            pointer-events: none;
            border-bottom-color: #F1F1F1  ;/*ì•„ë˜ë¡œ í–¥í•œ ì‚¼ê°í˜•ì„ ë§Œë“¤ë„ë¡ borderì„¤ì •í•¨*/
            border-width: 10px;
            right: 17%;
        }

        .chat .chat-history .my-message {/*ë©”ì„¸ì§€ë¥¼ ì…ë ¥í–ˆì„ ë•Œ my-messageê°€ ë‚˜ì˜´*/
            background: #F1F1F1;
            padding: 5px 10px;
            font-size: 15px;    
            width: 90%;
            color : black;            
        }

        .chat .chat-history .other-message {
            border: 1px solid #8A8A8A;
            padding: 5px 10px;
            font-size: 15px;
            width: 90%;
            color : black;
        }

        .chat .chat-history .other-message:after {
            border-bottom-color: #8A8A8A;
            left: 17%;
        }

        .chat .chat-message {
            padding: 5px 15px 0px 15px;
            background-color:#EFEFEF;
        }

        .chat .chat-message textarea {
            width: 100%;
            border: none;
            padding: 10px 20px;
            font: 14px/22px "Lato", Arial, sans-serif;
            border-radius: 15px;
            resize: none;
            margin-bottom: 20px;
        }

        .chat .chat-message textarea:focus {
            outline: none;
            border: 2px solid #DAA520; /* ì§™ì€ í™©ê¸ˆìƒ‰ */
        }

        .align-right {
            text-align: right;
            float: right;
        }

        .float-right {
            float: right;/*ìš”ì†Œê°€ ë¶€ëª¨ì˜ ë°•ìŠ¤ ì•ˆì—ì„œ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ë¶™ìŒ*/
            margin-right: 10px;
        }

        .float-left {
            float: left;
            margin-left: 10px;
        }

        .clearfix:after {/*ë¶€ëª¨ê°€ ìì‹ì˜ floatì†ì„±ë•Œë¬¸ì— ë†’ì´ë¥¼ ìƒëŠ” ê²ƒì„ ë°©ì§€í•¨*/
            visibility: hidden;
            display: block;
            font-size: 0;
            content: " ";
            clear: both;
        }

        .face-image {
            position: relative;
            top: 0.5rem;
            border-radius: 50%;
            width: 30px;
            height: 30px;
        }

         /* Added on 2023-08-22: Waiting animation styles */
         .loading-dots {
            display: inline-block;
            /* width: 30px; */
            height: 10px;
            text-align: center;
            font-size: 10px;
        }

        .loading-dots span {
            display: inline-block;
            width: 10px;
            height: 10px;
            margin: 0 2px;
            background-color: #555;
            border-radius: 50%;
            opacity: 0;/*íˆ¬ëª…ë„ ì„¤ì • ì™„ì „ íˆ¬ëª…*/
            animation: loading-dots 1.5s infinite;/*ì• ë‹ˆë©”ì´ì…˜ ë°˜ë³µ ì„¤ì •*/
            animation-timing-function: ease-in-out;
        }

        .loading-dots span:nth-child(1) { animation-delay: 0.1s; }/*loading-dotsì˜ ì²«ë²ˆì§¸ spanì—ë§Œ ì ìš©*/
        .loading-dots span:nth-child(2) { animation-delay: 0.3s; }
        .loading-dots span:nth-child(3) { animation-delay: 0.5s; }

        @keyframes loading-dots {/* í‚¤í”„ë ˆì„ìœ¼ë¡œ ì• ë‹ˆë©”ì´ì…˜ì„ ì •ì˜í•´ì„œ ìš”ì†Œì— ì ìš©í•¨*/
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }

        @keyframes blink {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0;
            }
        }

        .info {
            display: block;
            height: 1.2rem;
            font-size: 12px;
            color: #1A237E ;
            font-weight: bolder;
        }

        .blink {
            animation-name: blink;
            animation-duration: 2s;
            animation-delay: 0.5s;
            animation-iteration-count: 50;
        }

        .drag-over {/*ë‚˜ì¤‘ì— í´ë¼ìŠ¤ ë¦¬ìŠ¤íŠ¸ì— ì†ì„± ë”í•´ì„œ ì²˜ë¦¬í•˜ê²Œ í•´ì¤Œ scriptë¡œ*/
            /*background: #b39198*/
            background-color: rgba(0, 0, 0, 0.5);
        }
        .user-info {
  		display: flex;
  		flex-direction: column; /* ì„¸ë¡œ ë°©í–¥ ì •ë ¬ */
  		align-items: flex-start; /* ì™¼ìª½ ì •ë ¬ (ì›í•˜ë©´ centerë„ ê°€ëŠ¥) */
		}

        #file {/*idê°€ fileì¼ë•Œ inputìš”ì†Œë¥¼ ìˆ¨ê¸°ê³  íŠ¹ì •í•œ ê¸°ëŠ¥ì„ ì¶”ê°€í•˜ê¸° ìœ„í•´ì„œ displayë¥¼ noneìœ¼ë¡œ ì§€ì •í•¨ inputì˜ íƒ€ì…ì´ íŒŒì¼ì´ë©´ ëˆ„ë¥´ë©´ íŒŒì¼íƒìƒ‰ê¸° ë‚˜ì˜¤ëŠ” ë²„íŠ¼ì´ ìƒì„±ë¨*/
            display: none;
        }
		.modal {
  		font-family: 'NanumGothic';
  		position: fixed;
  		top: 45%;
  		left: 50%;
  		transform: translate(-50%, -50%);
  		background-color: white;
  		border: 1px solid #ccc;
  		padding: 20px;
  		box-shadow: 0 0 10px rgba(0,0,0,0.3);
  		z-index: 1000;
  		border-radius: 5px;
  		width: 400px; /* ì ë‹¹í•œ ë„ˆë¹„ ì§€ì • */
  		display: flex;
  		flex-direction: column;
		}

		.modal-overlay {
  		display: none;
  		position: fixed;
  		top: 0; left: 0;
  		width: 100vw; height: 100vh;
  		background: rgba(0, 0, 0, 0.5);
  		justify-content: center;
  		align-items: center;
  		z-index: 1000;
		}
        
		.modal-header {
  		display: flex;
  		justify-content: space-between;
  		align-items: center;
  		margin-bottom: 15px;
		}

		.modal-header h2 {
  		margin: 0;
		}        
        
        #toggleSettingsBtn {
  		padding: 5px 12px;
  		cursor: pointer;
		}
        
    	.modal-footer {
      	margin-top: 15px;
      	padding: 5px 10px;
      	background: white;
      	color: white;
      	border: none;
      	border-radius: 5px;
      	cursor: pointer;
        display: flex;
  		justify-content: flex-end;
  		gap: 10px;
    	}
		.modal-footer button {
        padding: 6px 12px;
        cursor: pointer;
        margin-top: 8px;
        margin-bottom: 8px;
        width: fit-content;
		}

        #ruleList li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 10px;
        }

        .rule-text {
        flex: 1;
        }

        .rule-actions {
        margin-left: 8px;
        }        

        .user {
  		color: #6a1b9a;
  		padding: 5px 5px;
		}

        #userList {
            display: flex;
            flex-wrap: wrap;
            gap: 10px; /* ìœ ì € ë²„íŠ¼ ì‚¬ì´ ê°„ê²© */
            margin-bottom: 20px; /* ë‹«ê¸° ë²„íŠ¼ê³¼ì˜ ê°„ê²© */
            justify-content: flex-start;
        }

        #userList button {
            width: fit-content;      /* ê¸€ì ê¸¸ì´ì— ë§ê²Œ ë²„íŠ¼ ë„ˆë¹„ */
            min-width: 60px;
            padding: 6px 12px;
            font-size: 15px;
            cursor: pointer;
        }
        .center-image {
            text-align: center;
        }
        .button-group button {
            display: flex;
            flex-direction: column;
            gap: 5px;
            font-size: 14px;
        }
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.7.7/handlebars.min.js"></script>
</head>

<body onload="loadRules()">
    <div class="container clearfix"><!-- ì»¨í…Œì´ë„ˆ ë°•ìŠ¤ì— ë””ìì¸í•  ìš”ì†Œë“¤ ì„¤ì •í•´ì„œ ë°°ì¹˜í•¨ -->
        <div class="chat">
            <div class="chat-header clearfix">
                <div class="button-group" style="display: flex; flex-direction: column; gap: 5px;">
                    <button onclick="openModal('modal1')">í•™ê¸‰ ê·œì¹™</button>
                    {% if role == "admin" %}
                    <button onclick="openModal('modal5')">ìŠ¹ì¸ ìš”ì²­</button>
                    {% endif %}
                </div>
                <img style="width:60px; border-radius:50px; margin-left:10px;" src="{{ url_for('static', filename='images/logo.png') }}?v=3" alt="moungbo" />
                <div class="chat-about" style="white-space: pre;">ìš°ë¦¬ë°˜ë³´ì•½</div>
                <div class="user-info">
                    <p>ğŸ‘¤: <span class="user" id="username">{{ username }}</span></p>
                	<p>ğŸª€: <span class="user" id="point">{{ point }}</span></p>
                </div>

            </div> <!-- end chat-header -->

            <div class="chat-history"> 
                <ul style="list-style:none;">

                </ul>
            </div> <!-- end chat-history -->

            <div class="chat-message">
                <span class=info></span>
                <textarea name="message-to-send" id="message-to-send" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”." rows="1"></textarea> 
                <div>
                    <input type="file" id="image-upload" style="display:none">
                    <button id="send" style="display:none">Send</button>
                </div>
            </div> <!-- end chat-message -->
        </div> <!-- end chat -->
    </div> <!-- end container -->
    <div class="modal-overlay" id="modal1" onclick="handleOverlayClick(event, 'modal1')">
  		<div class="modal" >
    		<div class="modal-header">
      			<h2>í•™ê¸‰ ê·œì¹™</h2>
      			<button id="toggleSettingsBtn" onclick="toggleEditMode()">ì„¤ì •</button>
    		</div>
    	<ul id="ruleList">
    	</ul>
    		<div class="modal-footer">
      			<button onclick="closeModal('modal1')">ë‹«ê¸°</button>
      			<button id="addRule" onclick="openModal('modal2')">ê·œì¹™ ì¶”ê°€</button>
    		</div>
  		</div>
	</div>

    <div class="modal-overlay" id="modal2" onclick="handleOverlayClick(event, 'modal2')">
  		<div class="modal">
    	<h2 class="modal-header">ê·œì¹™ ì¶”ê°€</h2>
    	<input
      	type="text"
      	id="newRuleInput"
      	placeholder="ìƒˆë¡œìš´ ê·œì¹™ ì…ë ¥"
      	onkeydown="moveToScoreEnter(event)"
      	style="width:100%; margin-bottom:10px;"
    	>

        <input
        type="number"
        id="newScoreInput"
        placeholder="ì ìˆ˜ ì…ë ¥"
        min="0"
        onkeydown="submitRuleEnter(event)"
        style="width:100%; margin-bottom:10px;"
        >

        <div class="modal-footer">
        	<button class="close-btn" onclick="handleRuleAddButtonClick()">ì¶”ê°€</button>
    		<button class="close-btn" onclick="closeModal('modal2')">ë‹«ê¸°</button>
        </div>
  		</div>
	</div>

    <div class="modal-overlay" id="modal3" onclick="handleOverlayClick(event, 'modal3')">
        <div class="modal">
            <h2 class="modal-header">ê·œì¹™ ìˆ˜ì •</h2>
            <input
            type="text"
            id="editRuleInput" 
        
            onkeydown="moveToEditScoreEnter(event)"
            style="width:100%; margin-bottom:10px;"
            > <!-- â˜… ê¸°ì¡´ newRuleInput â†’ editRuleInputë¡œ ë³€ê²½ -->
            
            <input
            type="number"
            id="editScoreInput"
            
            min="0"
            onkeydown="confirmEditEnter(event)"
            style="width:100%; margin-bottom:10px;"
            >
            <div class="modal-footer">
            <button class="close-btn" onclick="confirmEdit()">ìˆ˜ì •</button> <!-- ê¸°ì¡´ handleRuleAddButtonClick â†’ confirmEdit -->
            <button class="close-btn" onclick="closeModal('modal3')">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal4" onclick="handleOverlayClick(event, 'modal4')">
        <div class="modal">
            <h3 class="modal-header">ì ìˆ˜ ë¶€ì—¬</h3>
            <div id="userList"></div>

            <button class="close-btn" onclick="closeModal('modal4')">ë‹«ê¸°</button>
        </div>
    </div>
    <div class="modal-overlay" id="modal5" onclick="handleOverlayClick(event, 'modal5')">
        <div class="modal">
            <h3 class="modal-header">ìŠ¹ì¸ ìš”ì²­ ëª©ë¡</h3>
            <div id="approveUserList"></div>
            <div class="modal-footer">
                <button class="close-btn" onclick="closeModal('modal5')">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <audio id="audioPlayer" controls style="display:none"></audio>
    <!-- í•¸ë“¤ë°” í…œí”Œë¦¿ ì‚¬ìš©í•´ì„œ ë©”ì„¸ì§€ë¥¼ ë™ì ìœ¼ë¡œ ëœë”ë§í•˜ê¸°ìœ„í•œ í…œí”Œë¦¿ jsê°€ ë™ì ìœ¼ë¡œ ë©”ì„¸ì§€ë¥¼ ì½ê³  ë¶™ì„ ë©”ì„¸ì§€ ë³€ìˆ˜ì— ë‹´ì•„ì„œ í…œí”Œë¦¿ì˜ ë§¤ê°œë³€ìˆ˜ë¡œ í•¨ìˆ˜ì‹¤í–‰í•¨ -->
     <script id="message-template" type="text/x-handlebars-template"> 
         {% raw %}
        <li class="clearfix">
            <div class="message-data align-right">                
                <span class="message-data-name" >ë‚˜</span>
                <span class="message-data-time" >Today</span> &nbsp; &nbsp;                
            </div>
            <div class="message my-message float-right">
                {{messageOutput}}
                {{#if imageUrl}}
                	<div class="center-image">
                    	<img src="{{imageUrl}}" alt="Uploaded Image" style="max-width: 250px; display: inline; margin: 10px;">
                    </div> <!-- end center-image -->
                {{/if}}
            </div>
      </li>
      {% endraw %}
    </script>
<!-- clearfix í´ë˜ìŠ¤ëŠ” ìì‹ìš”ì†Œì— ë§ê²Œ ë†’ì´ ìë™ìœ¼ë¡œ ë§ì¶°ì§, divìš”ì†ŒëŠ” displayì†ì„±ì´ ìë™ì ìœ¼ë¡œ blockì´ë¼ ì¶”ê°€ë˜ë©´ ì¤„ë°”ê¿ˆë¼ì„œ ë°°ì¹˜ë¨-->
    <script id="message-response-template" type="text/x-handlebars-template">
        {% raw %}
        <li class="clearfix">
            <div class="message-data">
                <img src="/static/images/trainer.png?v=1" class="face-image"?>
                <span class="message-data-name">ì¹­ì°¬ë§¨</span>
                <span class="message-data-time">Today</span>
            </div>
            <div class="message other-message float-left">
                {{#if loading}}
                    <div class="loading-dots"><span></span><span></span><span></span></div>
                {{else}}
                    {{{messageOutput}}}
                    {{#if imageUrl}}
                        <div style="display: flex; justify-content: center; align-items: center;">
                            <img src="{{imageUrl}}" alt="Uploaded Image" style="max-width: 200px; display: block; margin: 10px;">
                        </div>
                    {{/if}}
                {{/if}}                
            </div>
        </li>      
        {% endraw %}
    </script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io(); // ì†Œì¼“ ì—°ê²° ì´ˆê¸°í™”
        (function () {<!-- ì¦‰ì‹œì‹¤í–‰í•¨ìˆ˜ í•œë²ˆë§Œ ì‹¤í–‰ë¨ ì´ˆê¸°í™” ë‚´ìš© ì ìš©-->
            var chat = {
                messageToSend: '',//ë©”ì„¸ì§€ ì°½ì— í‘œì‹œí•˜ëŠ” í˜•íƒœë¡œ ë©”ì„¸ì§€, ë“œë¡­ëœ íŒŒì¼ ëŒ€í•´ì„œ ì²˜ë¦¬í•˜ëŠ” ë¡œì§
                init: function () {
                    this.cacheDOM();//ì—¬ê¸°ì„œ thisëŠ” chatì´ë¼ëŠ” ê°ì²´ì„ ê·¸ ê°ì²´ì— ëŒ€í•´ì„œ ì´ˆê¸°í™” ì„¤ì •í•¨ìˆ˜ document.querySelectorí•¨ìˆ˜ë¡œ ìë™ì ìœ¼ë¡œ ì„¤ì •í•´ì¤Œ sendë²„íŠ¼, ëŒ€í™”ë‚´ìš© ê°ì²´ë¡œ ê°€ì ¸ì˜´
                    this.bindEvents();//cacheDOMì—ì„œ ì„¤ì •í•œ ê²ƒìœ¼ë¡œ ì´ë²¤íŠ¸ë¦¬ìŠ¤ë„ˆë¡œ ì—°ê²°í•¨
                },                
                // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë¥¼ chat ê°ì²´ ë‚´ì— í¬í•¨ì‹œí‚µë‹ˆë‹¤.
                initDragAndDrop: function () {
                    var self = this; // í˜„ì¬ chat ê°ì²´ë¥¼ self ë³€ìˆ˜ì— ì €ì¥
                    var dropArea = document.querySelector('body');
                    if (!dropArea) {
                        console.error('Drop area not found');
                        return;
                    }

                    // ë“œë˜ê·¸ ì˜¤ë²„ ì´ë²¤íŠ¸(íŒŒì¼ì„ ë“œë˜ê·¸í•´ì„œ ê°€ì ¸ì™”ì„ë•Œ ìƒˆ íƒ­ì—ì„œ ì—´ë¦¬ëŠ” í˜„ìƒ ë°‘ì— ìˆëŠ”preventDefaults í•¨ìˆ˜) ë°©ì§€ ë°”ê¹¥ ìŠ¤ì½”í”„ ì°¸ê³ í•˜ëŠ” í™”ì‚´í‘œí•¨ìˆ˜ ì‚¬ìš©í•¨ thisê°€ dropAreaë¡œ ì¸ì‹í•˜ëŠ” í˜„ìƒ ë°©ì§€
                    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                        dropArea.addEventListener(eventName, this.preventDefaults, false);
                    });

                      // ë“œë¡­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ inputìš”ì†Œì— ìë™ìœ¼ë¡œ ë¶™ê³  ë¯¸ë¦¬ë³´ê¸°ê°€ ì‹¤í–‰ë¨ ì—¬ê¸°ì„œ thisëŠ” chat ê°ì²´ë¥¼ ê°€ë¦¬í‚´ .bindê°€ ìˆì–´ì„œì„ í•¨ìˆ˜ì‹¤í–‰ì—ì„œ ë‚´ë¶€ ì ìœ¼ë¡œëŠ” dropAreaì°¸ê³ í•´ì•¼í•¨
                    dropArea.addEventListener('drop', this.handleDrop.bind(this), false);
                },
                preventDefaults: function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                },
            
                handleDrop: function (e) {//íŒŒì¼ì„ ì°¨ë¡€ëŒ€ë¡œ ì—…ë¡œë“œí•˜ëŠ” í•¨ìˆ˜ ì´ë²¤íŠ¸ì— ëŒ€í•´ ì‹¤í–‰í•  í•¨ìˆ˜ë¥¼ ì„¤ì •í•¨
                    let dt = e.dataTransfer;
                    let files = dt.files;
            
                    this.handleFiles(files);
                },
            
                handleFiles: function (files) {
                    ([...files]).forEach(this.uploadFile.bind(this));//íŒŒì¼ì„ ë°°ì—´í˜•íƒœë¡œ ì—…ë¡œë“œí•¨
                },
            
                uploadFile: function (file) {
                    var fileInput = document.getElementById('image-upload');
                    var dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    fileInput.files = dataTransfer.files;
            
                    // ë¯¸ë¦¬ë³´ê¸° ê¸°ëŠ¥ì„ í˜¸ì¶œí•©ë‹ˆë‹¤. ë°‘ì— í•¨ìˆ˜ ìˆìŒ ì´ë¯¸ì§€ ëœë”ë§í•´ì„œ ë¯¸ë¦¬ë³´ê¸°ë§Œ ë„ìš°ê¸°
                    this.previewImage();
                },
                // Cache DOM elements
                cacheDOM: function () {
                    this.chatHistory = document.querySelector('.chat-history');
                    this.button = document.querySelector('#send');
                    this.textarea = document.getElementById('message-to-send');
                    this.chatHistoryList = this.chatHistory.querySelector('ul');
                },
                // Bind events to elements ìœ„ì—ì„œ ì„¤ì •í•œ ê°ì²´ì— ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆì„ ë•Œ ì–´ë–¤ í•¨ìˆ˜ê°€ ì‹¤í–‰ë ì§€ ì„¤ì •í•¨
                bindEvents: function () {
                    this.button.addEventListener('click', this.addMessage.bind(this));
                    this.textarea.addEventListener('keyup', this.addMessageEnter.bind(this));
                    document.getElementById('image-upload').addEventListener('change', this.previewImage.bind(this));//image-uploadë¡œ í¼ìš”ì†Œì˜ ê°’ì´ ë³€í–ˆì„ ë•Œ(inputì˜ ê°ì²´ê°€ ë³€í–ˆì„ë•Œ) previewImageí•¨ìˆ˜ ì‹¤í–‰ë¨
                },
                // Render a new message isUserì´ trueì´ë©´ ì‚¬ìš©ìë©”ì„¸ì§€ falseì´ë©´ ìƒëŒ€ë°© ë©”ì„¸ì§€
                render: function (message, imageUrl, isUser) {
                    //this.scrollToBottom();

                    const templateId = isUser ? "#message-template" : "#message-response-template";//isUserê°€ trueì´ë©´ ì•ì— ê°’, falseë©´ ë’¤ì— ê°’ í• ë‹¹                    

                    const template = Handlebars.compile(document.querySelector(templateId).innerHTML);
                    //HTMLì—ì„œ templateIdê°ì²´ë¥¼ ì„ íƒí•´ì„œ ê·¸ ê°ì²´ë¥¼ ë¸Œë¼ìš°ì €ê°€ ì¸ì‹í•  ìˆ˜ ìˆëŠ” ì½”ë“œë¡œ ë°”ê¿”ì¤Œ handlebars ì‚¬ìš©í•˜ê² ë‹¤ëŠ” í‘œì‹œê°€ ìŠ¤í¬ë¦½íŠ¸ë¡œ htmlíŒŒì¼ì— ìˆì–´ì•¼í•¨ type="text/x-handlebars-template"

                    const context = {
                        messageOutput: message,
                        imageUrl: imageUrl, 
                        time: this.getCurrentTime()
                    };

                    let htmlString = template(context)
                    if (isUser) {
                    	this.chatHistoryList.insertAdjacentHTML('beforeend', htmlString);
                    }//ì±„íŒ…ì°½ì— ë™ì ìœ¼ë¡œ htmlì¶”ê°€, ì¶”ê°€ëœ í›„ ìë™ ìŠ¤í¬ë¡¤ ë‚´ë¦¼
                    else {
                        this.chatHistoryList.lastElementChild.innerHTML = htmlString;
                    }
                    this.scrollToBottom();

                    if (isUser) {
                        
                        this.textarea.value = '';
                    }
                },
                showResponse:  function (message) {
                    this.scrollToBottom();
                    const templateId = "#message-response-template";//idê°€ ì´ê²ƒì´ê³  <script type="text/x-handlebars-template">ì¸ ìš”ì†Œë¥¼ ì°¾ì•„ì„œ í…œí”Œë¦¿ ì½”ë“œë¥¼ templateSourceì— ì €ì¥í•¨
                    let templateSource = document.querySelector(templateId).innerHTML;
                    const template = Handlebars.compile(templateSource);//í…œí”Œë¦¿ì„ ê°ì²´í™”í•¨
                    const context = {
                        messageOutput: message,
                        time: this.getCurrentTime()
                    };
                    let htmlString = template(context);//ë©”ì„¸ì§€ì— í…œí”Œë¦¿ì„ ì ìš©í•¨
                    
    
                    document.querySelector('.chat-history > ul > li:last-child').innerHTML = htmlString//ì±„íŒ…ì°½ì— ìˆëŠ” htmlêµ¬ì¡° ì¤‘ ë§ˆì§€ë§‰ì— ë©”ì„¸ì§€ ë°ì´í„°ë¥¼ ë„ì›€ ë™ì ìœ¼ë¡œ htmlì˜ êµ¬ì¡°ì— ì¶”ê°€í•œë‹¤ëŠ” ì½”ë“œì„
                    this.scrollToBottom();                    
                },     
                 // ì¼ì • ì‹œê°„(seconds) ê²½ê³¼ ì‹œì ì„ ì•Œë¦´ ìˆ˜ ìˆëŠ” ë¹„ë™ê¸° í•¨ìˆ˜
                waitSeconds: async function (delay) {
                    return new Promise(resolve => {
                        this.waitTime = 0;//ê¸°ë‹¤ë¦¼ì„ êµ¬í˜„
                        setTimeout(() => {
                            resolve();
                        }, delay + this.waitTime);//ì²˜ìŒ ì„¤ì •í•œ ì‹œê°„ ë§Œí¼ ê¸°ë‹¤ë ¸ë‹¤ê°€ ë‹¤ìŒì—ëŠ” delayë§Œí¼ë§Œ ê¸°ë‹¤ë ¸ë‹¤ ë‹¤ìŒ ì½”ë“œ í˜¸ì¶œí•¨
                    });
                },
                showBubbleAfterSeconds: async function (delay) {
                    return new Promise(resolve => {
                        setTimeout(() => {
                            const templateId = "#message-response-template";//ì„¤ì •í•œ í…œí”Œë¦¿ ê°€ì ¸ì˜¤ëŠ” ì½”ë“œ
                            const template = Handlebars.compile(document.querySelector(templateId).innerHTML);
                            const context = {
                                loading: true,//context ë‚´ìš©ì´ ë¡œë”©ì¤‘ì´ë¼ëŠ” ë‚´ìš©ì„
                                time: this.getCurrentTime()
                            };
                            // ë¬¼ë°©ìš¸ ì• ë‹ˆë©”ì´ì…˜ì„ ì‹œì‘í•©ë‹ˆë‹¤.
                            var loadingHtml = template(context);
                            this.chatHistoryList.insertAdjacentHTML('beforeend', loadingHtml);//chathistorylistì˜ ë§ˆì§€ë§‰ì— ë¡œë”©ì¤‘ì„ ì¶”ê°€í•¨
                            this.scrollToBottom();
                            resolve();
                        }, delay);
                    });
                },
                throwPokemon: async function () {
    				const randomId = Math.floor(Math.random() * 1025) + 1;
    				const imageUrl = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${randomId}.png`;
                    const name = await this.getPokemonKoreanName(randomId)
                    const message = `${name} ì¡ì•˜ë‹¤!!`;
                    this.render(message, imageUrl, false);
                    
                },
                getPokemonKoreanName: async function(id) {
                    const res = await fetch(`https://pokeapi.co/api/v2/pokemon-species/${id}`);
            		const data = await res.json();
            		const koreanEntry = data.names.find(entry => entry.language.name === "ko");
            		return koreanEntry ? koreanEntry.name : "(ì´ë¦„ ì—†ìŒ)";
                },
                catchPokemon: async function(username, amount) {
                    const admin = "{{ room_name }}"; // í…œí”Œë¦¿ ë³€ìˆ˜ë¡œ í˜„ì¬ ì±„íŒ…ë°© ê´€ë¦¬ì ì´ë¦„ ì „ë‹¬
                    const res = await fetch("/catchpokemon", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ username, amount, admin })//adminì¶”ê°€
                	});
                    const result = await res.json();
                    if (result.success) {
                        await this.throwPokemon();
                        document.getElementById("point").innerText = result.new_point;
                    }
                    else {
                        this.render(result.message, null, false)
                    }
                },
 
                // Add a message and its response
                addMessage: async function () {
                    const username = "{{ username }}";
                    const formData = new FormData();//FormDataëŠ” ì„œë²„ì— ë³´ë‚¼ ë°ì´í„°ë¥¼ ë”•ì…”ë„ˆë¦¬ í˜•ì‹ìœ¼ë¡œ ì¶”ê°€í•  ìˆ˜ ìˆê²Œ í•˜ëŠ” ê°ì²´ë¥¼ ë§Œë“¤ì–´ì£¼ëŠ” í•¨ìˆ˜ì„
                    this.messageToSend = this.textarea.value.trim();//textareaì˜ domìš”ì†Œì— ì…ë ¥ê°’ì„ ê³µë°± ì œê±°í•´ì„œ ê°€ì ¸ì˜´
                    if (this.messageToSend){
                        this.render(this.messageToSend, null, true);
                    	}//renderí•¨ìˆ˜ë¡œ ë‚´ê°€ ë³´ë‚¸ ë©”ì„¸ì§€ë¥¼ ë¨¼ì € ì±„íŒ…ì°½ì— ë„ì›Œì¤Œ
                    if (this.messageToSend.startsWith("!")){
                    	showBubblePromise = this.showBubbleAfterSeconds(500)
                    	waitPromise = this.waitSeconds(1500)
                    	await showBubblePromise //ë‹µë³€ì´ ì¶œë ¥ë˜ê³  ë²„ë¸”ë§ì´ ë°œìƒë˜ëŠ” í˜„ìƒ ì œì–´
                    	await waitPromise  //ìµœì†Œ 2ì´ˆëŠ” ë²„ë¸”ë§
                		if (this.messageToSend === "!ë˜ì ¸") {
                        	await this.catchPokemon(username, -500);
                    		}
                        else if (this.messageToSend.startsWith("!ì „ë‹¬ ")) {
                            const give = this.messageToSend.split(" ")
						    if (give.length < 3) {
					        this.render("ì „ë‹¬í•  ì‚¬ìš©ì ì´ë¦„ê³¼ í¬ì¸íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”. ì˜ˆ: !ì „ë‹¬ ì´ë¦„ 100", null, false);
					        return;
						    }                            
                            const targetName = give[1]
    						const givingPoint = Number(give[2])

    						if (!/^\d+$/.test(givingPoint)) {
        						this.render("ìœ íš¨í•œ í¬ì¸íŠ¸ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”. ì˜ˆ: !ì „ë‹¬ ì´ë¦„ 100", null, false);
        						return;
    						}
                            const res = await fetch("/give_point", {
    							method: "POST",
    							headers: { "Content-Type": "application/json" },
    							body: JSON.stringify({
        						to: targetName,
        						amount: givingPoint,  // ì›í•˜ëŠ” í¬ì¸íŠ¸ ì–‘ì„ ì¶”ê°€
                                admin: "{{ room_name }}" // í…œí”Œë¦¿ ë³€ìˆ˜ë¡œ í˜„ì¬ ì±„íŒ…ë°© ê´€ë¦¬ì ì´ë¦„ ì „ë‹¬
    								})
								});
        					const result = await res.json();
        					if (result.success) {
            					this.render(result.message, null, false);  // ì„±ê³µ ë©”ì‹œì§€ ì¶œë ¥
            					document.getElementById("point").innerText = result.new_point;
        					} 
                        	else {
            					this.render(result.message, null, false);  // ì‹¤íŒ¨ ë©”ì‹œì§€ ì¶œë ¥
        						}
                    		}
                    	else {
                            this.render("ê·¸ê±´ ì•Œ ìˆ˜ ì—†ëŠ” ë§ì´ì•¼.", null, false)
                        	}
                    document.getElementById('image-upload').value = ''; // ì´ë¯¸ì§€ í•„ë“œ ì´ˆê¸°í™” ì¡´ì¬í•  ë•Œë¥¼ ì¡°ê±´ìœ¼ë¡œ ì‹¤í–‰í•˜ëŠ” ê²½ìš°ë„ ìˆê³  ë‹¤ì‹œ ê°™ì€ ì´ë¯¸ì§€ ì—…ë¡œë“œí•´ë„ changeê°€ ë°œìƒí•˜ì§€ ì•ŠëŠ” ê²½ìš°ë„ ìˆìŒ
                	}
                },
                // Add a message when the Enter key is pressed
                addMessageEnter: function (event) {
                    if (event.keyCode === 13) {//ì—”í„° í‚¤ì½”ë“œ ì—”í„° ëˆŒë €ì„ ë•Œ addMessage ì‹¤í–‰
                        this.addMessage();
                    }   
                },
                // Scroll to the bottom of the chat history
                scrollToBottom: function () {
                    this.chatHistory.scrollTop = this.chatHistory.scrollHeight;//í˜„ì¬ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ê°’ì„ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ ìµœëŒ€ ë†’ì´ chat-chatHistoryëŠ” ì±„íŒ…ì°½ DOMì„
                },
                // Get the current time
                getCurrentTime: function () {
                    let currentDate = new Date();
                    return currentDate.toLocaleDateString('ko-KR', { month: 'long', day: 'numeric' });
                    
                },
                // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° í•¨ìˆ˜
                previewImage: function() {
                    this.scrollToBottom();
                    const imageFile = document.getElementById('image-upload').files[0];
                    if (imageFile) {
                        const imageUrl = URL.createObjectURL(imageFile);//ë¸Œë¼ìš°ì €ê°€ ëœë”ë§ í•  ìˆ˜ ìˆë„ë¡ ì„ì‹œë¡œ ì´ë¯¸ì§€ urlì„ ë§Œë“¤ì–´ ì¤Œ
                        this.render('', imageUrl, true);
                        document.getElementById('image-upload').value = '';// ë¹ˆ ë©”ì‹œì§€ë¡œ ì´ë¯¸ì§€ë§Œ ë Œë”ë§ í™”ë©´ì— ë„ì›Œì¤Œ
                    }
                },
            };
            chat.init();//ì±„íŒ…ê¸°ëŠ¥ ì´ˆê¸°í™” ì‹¤í–‰, ë“œë˜ê·¸ì•¤ë“œë¡­ê¸°ëŠ¥ ì„¤ì • ì‹¤í–‰
            chat.initDragAndDrop();
        })();

        function openModal(id) {
    	    document.getElementById(id).style.display = "flex";
            if (id === "modal5") {
                loadApproveUserList();
            }
  		}

  		function closeModal(id) {
    		document.getElementById(id).style.display = "none";
            currentEditItem = null;
  		}
		function handleOverlayClick(event, modalId) {//ë°°ê²½ì„ í´ë¦­í–ˆì„ ë•Œ í™”ë©´ ë‹«ê¸°
  			if (event.target === event.currentTarget) {
    			closeModal(modalId);
  			}
		}
        const role = "{{ role }}";
        if (role !== "admin") {
            document.getElementById("addRule").style.display = "none";
            document.getElementById("toggleSettingsBtn").style.display = "none";
        }
        function submitRule(ruleInput, scoreInput) {//ì„œë²„ì— ê·œì¹™ ì œì¶œ
          const newRule = ruleInput.value.trim();
          const newScore = scoreInput.value.trim();
          if (newRule === "" || newScore === "") return;

          const ruleList = document.getElementById("ruleList");
          const newItem = document.createElement("li");

          const textSpan = document.createElement("span");
          textSpan.className = "rule-text";
          textSpan.textContent = `${newRule} (${newScore}ì )`;
          newItem.appendChild(textSpan);   //liì— textì íŒ span ì¶”ê°€

          ruleList.appendChild(newItem);
          ruleInput.value = "";
          scoreInput.value = "";
          closeModal("modal2");

          fetch("/add_rule", {//ì„œë²„ì— ì „ë‹¬
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ content: newRule, score: Number(newScore) })
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
                newItem.setAttribute("data-id", data.id); // â† â˜… idë¥¼ liì— ì €ì¥
                loadRules();
            }
          });
        }
        let currentEditItem = null;//li ì €ì¥ìš© ë³€ìˆ˜        
        let editMode = false;
        
        function toggleEditMode() {//ìˆ˜ì •ëª¨ë“œ ìˆ˜ì •í•  ë•Œ í•„ìš”í•œ ì½”ë“œê°€ ìˆìŒ
        editMode = !editMode;//ìˆ˜ì •,ì‚­ì œëª¨ë“œì¼ë•Œë§Œ ë²„íŠ¼ì´ ìƒˆë¡œ ìƒì„±ë¼ì„œ í‘œì‹œë˜ê²Œ
        const ruleItems = document.querySelectorAll("#ruleList li");//liê°ê° ë¶ˆëŸ¬ì˜¤ê¸° liì˜ span-text, span-button

        ruleItems.forEach((item) => {
            if (editMode) {
            const actions = document.createElement("span");
            actions.className = "rule-actions";//ê°ê°ì˜ spanì— í´ë˜ìŠ¤ëª… ì§€ì •

            // ìˆ˜ì • ë²„íŠ¼
            const editBtn = document.createElement("button");
            editBtn.textContent = "ìˆ˜ì •";
            editBtn.className = "edit-btn";
            editBtn.onclick = () => editRule(item);//ìˆ˜ì • ê¸°ëŠ¥ì€ ë”°ë¡œ ë°‘ì— í•¨ìˆ˜ë¡œ ë¹¼ë‘ 

            // ì‚­ì œ ë²„íŠ¼
            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "ì‚­ì œ";
            deleteBtn.className = "delete-btn";
            deleteBtn.onclick = () => {
            const id = item.dataset.id;
            fetch('/delete_rule', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id })
            }).then(res => res.json())
                .then(data => {
                if (data.success) {
                    item.remove();
                } else {
                    alert('ì‚­ì œ ì‹¤íŒ¨');
                }
                });
                document.getElementById("toggleSettingsBtn").click();
            };

            const giveScoreBtn = document.createElement("button");
            giveScoreBtn.textContent = "ğŸ§‘";
            giveScoreBtn.className = "give-score-btn";
            giveScoreBtn.onclick = () => openScoreModal(item);

            // ì¤‘ë³µ ì¶”ê°€ ë°©ì§€
            actions.appendChild(giveScoreBtn);
            actions.appendChild(editBtn);
            actions.appendChild(deleteBtn);
            if (!item.querySelector(".rule-actions")) item.appendChild(actions);

            } else {
            // í¸ì§‘ ëª¨ë“œ í•´ì œ ì‹œ ë²„íŠ¼ ë¬¶ìŒ ì „ì²´ ì œê±°
            const actions = item.querySelector(".rule-actions");
            if (actions) actions.remove();
            }
        });
        }

        function editRule(item) {
            currentEditItem = item;
            
            const textSpan = item.querySelector(".rule-text");
            const fullText = textSpan.textContent.trim();

            // "ê·œì¹™ ë‚´ìš© (5ì )" í˜•íƒœë¼ë©´ ì ìˆ˜ ë¶„ë¦¬í•˜ê¸°
            const match = fullText.match(/^(.*)\s\((\d+)ì \)$/);

            let oldContent = fullText;
            let oldScore = "";

            if (match) {
                oldContent = match[1]; // ê·œì¹™ ë‚´ìš©
                oldScore = match[2];   // ì ìˆ˜ (ë¬¸ìì—´)
            }

            const contentInput = document.getElementById("editRuleInput");
            const scoreInput = document.getElementById("editScoreInput");

            // placeholder ëŒ€ì‹  ë°”ë¡œ valueë¡œ ë„£ëŠ” ê²Œ ë” UX ì¢‹ìŒ
            contentInput.value = oldContent;
            scoreInput.value = oldScore;

            document.getElementById("modal3").style.display = "flex"; // ëª¨ë‹¬ ë„ìš°ê¸°
        }

        function confirmEdit() {
            const contentInput = document.getElementById("editRuleInput");
            const scoreInput = document.getElementById("editScoreInput");
            const newText = contentInput.value.trim();
            const newScore = scoreInput.value.trim();

            if (!newText) {
                alert("ìˆ˜ì •í•  ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }
            if (newScore === "" || isNaN(newScore)) {
                alert("ìœ íš¨í•œ ì ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }
            const item = currentEditItem;
            const ruleId = item.dataset.id;
            const textSpan = item.querySelector(".rule-text");

            fetch("/update_rule", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id: ruleId, content: newText, score: Number(newScore) }),
            })
            .then(res => res.json())
            .then(result => {
                if (result.success) {
                    textSpan.textContent = `${newText} (${newScore}ì )`;
                    document.getElementById("toggleSettingsBtn").click(); // ì„¤ì • ë²„íŠ¼ ìë™ ë‹«ê¸°
                    closeModal("modal3");
                } else {
                    alert("ìˆ˜ì • ì‹¤íŒ¨");
                }
            });
        }

        function openScoreModal(item) {
            // ì„ íƒí•œ ê·œì¹™ ì €ì¥
            currentEditItem = item;
            const modal = document.getElementById('modal4');
            modal.style.display = 'flex';

            const userListDiv = document.getElementById('userList');
            userListDiv.innerHTML = ''; // ê¸°ì¡´ ë²„íŠ¼ ì œê±°

            // ì„œë²„ì—ì„œ ìœ ì € ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            fetch("/get_users")
                .then(res => res.json())
                .then(users => {
                    users.forEach(user => {
                        const btn = document.createElement("button");
                        btn.textContent = user.username;
                        btn.onclick = async () => {
                            const ruleId = currentEditItem.dataset.id;       // liì— ì €ì¥ëœ id
                            const res = await fetch("/give_score", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({
                                    ruleId: ruleId,
                                    user: user.username
                                })
                            });

                            const data = await res.json();
                            if (data.success) {
                                alert(`${user.username}ì—ê²Œ ${data.score}ì  ë¶€ì—¬ ì™„ë£Œ`);
                            } else {
                                alert("ì ìˆ˜ ë¶€ì—¬ ì‹¤íŒ¨");
                            }
                            modal.style.display = 'none';
                        };

                        userListDiv.appendChild(btn);
                    });
                });
        }

        function loadApproveUserList() { // ë¡œê·¸ì¸í•œ ì‚¬ëŒì´ adminì¼ë•Œ ëª¨ë‹¬ì´ ëœ¨ê²Œí•´ì„œ ëª¨ë‹¬ì´ ëœ¬ì‚¬ëŒì˜ ë¡œê·¸ì¸ì •ë³´ í™œìš©í•œê±°ì„
            const adminUsername = "{{ username }}";
            const approveUserListDiv = document.getElementById('approveUserList');
            approveUserListDiv.innerHTML = ''; // ê¸°ì¡´ ë²„íŠ¼ ì œê±°

            fetch(`/get_approve_users?admin=${encodeURIComponent(adminUsername)}`)
                .then(res => res.json())
                .then(users => {
                    if (users.length === 0) {
                        approveUserListDiv.innerHTML = '<p>ìŠ¹ì¸ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                        return;
                    }
                    users.forEach(user => {
                        const btn = document.createElement("button");
                        btn.textContent = user.username;
                        btn.onclick = async () => {
                            const admin = "{{ username }}"; // í˜„ì¬ ë¡œê·¸ì¸í•œ ê´€ë¦¬ì ì´ë¦„(ì±„íŒ…ë°© ì´ë¦„)
                            const res = await fetch("/approve_user", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ username: user.username, admin }) // usernameê³¼ admin ì „ë‹¬
                            });
                            const data = await res.json();
                            if (data.success) {
                                alert(`${user.username} ìŠ¹ì¸ ì™„ë£Œ`);
                                loadApproveUserList(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                            } else {
                                alert("ìŠ¹ì¸ ì‹¤íŒ¨");
                            }
                        };
                        approveUserListDiv.appendChild(btn);
                    });
                });
        }

        function confirmEditEnter(event) {
          if (event.key === "Enter") {
            const input = event.target;
            confirmEdit();
          }            
        }
        function moveToEditScoreEnter(event) {
          if (event.key === "Enter") {
            event.preventDefault(); // í¼ ì œì¶œ ë°©ì§€
            document.getElementById("editScoreInput").focus(); // ì ìˆ˜ ì…ë ¥ì¹¸ìœ¼ë¡œ ì´ë™
          }
        }
        function submitRuleEnter(event) {//htmlê³¼ ì—°ê²°í•  í•¨ìˆ˜
          if (event.key === "Enter") {
            const input = event.target;
            submitRule(
                document.getElementById("newRuleInput"),
                document.getElementById("newScoreInput")
            );
          }
        }
        function moveToScoreEnter(event) {
          if (event.key === "Enter") {
            event.preventDefault(); // í¼ ì œì¶œ ë°©ì§€
            document.getElementById("newScoreInput").focus(); // ì ìˆ˜ ì…ë ¥ì¹¸ìœ¼ë¡œ ì´ë™
          }
        }

        function handleRuleAddButtonClick() {//htmlê³¼ ì—°ê²°í•  í•¨ìˆ˜
            submitRule(
                document.getElementById("newRuleInput"),
                document.getElementById("newScoreInput")
            );
        }
        
		function loadRules() {
  			fetch("/get_rules")
    		.then(res => res.json())
    		.then(ruleList => {
      		const ruleUl = document.getElementById("ruleList");
      		ruleUl.innerHTML = ""; // ê¸°ì¡´ ê·œì¹™ ì´ˆê¸°í™”
      		ruleList.forEach(rule => {
        		const li = document.createElement("li");
                li.dataset.id = rule._id;

                const textSpan = document.createElement('span');
                textSpan.className = 'rule-text';
                textSpan.textContent = `${rule.content} (${rule.score}ì )`;

        		li.appendChild(textSpan);
        		ruleUl.appendChild(li);
      		});
    		});
		}
        
        document.addEventListener('DOMContentLoaded', function () {//ì›¹í˜ì´ì§€ì— HTMLì´ ì™„ì„±ë˜ê³  DOM íŠ¸ë¦¬ê±°ê°€ ì™„ì„±ëœ ì´ë²¤íŠ¸
            var dropArea = document.querySelector('body');

            if (!dropArea) {
                console.error('Drop area not found');
                return;
            }

            function preventDefaults(e) {
                e.preventDefault();//ê¸°ë³¸ë™ì‘ ë°©ì§€(ìƒˆ í…ì— ì—¬ëŠ” ë™ì‘)
                e.stopPropagation();//ì´ë²¤íŠ¸ë²„ë¸”ë§ë°©ì§€
            }

            function highlight(e) {
                dropArea.classList.add('drag-over');//dropAreaìš”ì†Œì— drag-over CSSí´ë˜ìŠ¤ ì¶”ê°€í•˜ëŠ” ì½”ë“œì„
            }

            function unhighlight(e) {
                dropArea.classList.remove('drag-over');
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);//íŒŒì¼ì„ ëŒì–´ì˜¤ë©´(ë‘ ë¦¬ìŠ¤íŠ¸ ì´ë²¤íŠ¸) dropAreaì˜ í´ë˜ìŠ¤ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€ë˜ì–´ CSSìŠ¤íƒ€ì¼ì´ ì ìš©ë¨
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });

        });

    </script>

</body>

</html>