<!DOCTYPE html> 
<html lang="en">  
  
<head>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>  
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preload stylesheet" as="style" href='https://fonts.googleapis.com/css2?family=Gothic+A1:wght@200&family=Nanum+Gothic&family=Nanum+Myeongjo&family=Noto+Sans+KR:wght@400&family=Roboto:wght@100&display=swap'>    
    <title>ìš°  ë³´</title>
    <style>/*í—¤ë“œì˜ ìŠ¤íƒ€ì¼ì€ ì‚¬ìš©í•  ìš”ì†Œë“¤ì˜ ìŠ¤íƒ€ì¼ë§Œ ì§€ì •í•¨ ì»¨í…Œì´ë„ˆë°•ìŠ¤ ì•ˆì—ì„œ ì¶”ê°€ëœë‹¤ë©´ ì–´ë””ì„œ ì¶”ê°€ë ì§€ ì´ë¯¸ì§€ë¡œë§Œ ì„¤ì •í•¨ ìŠ¤í¬ë¦½íŠ¸ì™€ í˜¸í™˜ì€ x í°íŠ¸ë‚˜ ìœ„ì¹˜, ì—ë‹ˆë©”ì´ì…˜ ì •ë„ë¡œë§Œ ì„¤ì • ë‚˜ì¤‘ì— jsì—ì„œ ê¸°ëŠ¥ ì¶”ê°€í•  ë•Œ ê³ ë ¤í•´ì„œ noneì •ë„ë§Œ ë‹¨ìˆœ ë””ìì¸ë§Œ ì„¤ì •í•¨*/
        @import url('https://fonts.googleapis.com/css?family=Lato:400,700');
        @import url('https://fonts.googleapis.com/css?family=Do+Hyeon:400');

        @font-face {
            font-family: 'NanumGothic';
            font-style: normal;
            src: url("/static/fonts/NanumGothic-Regular.ttf");
        }

        *,
        *:before, 
        *:after {
            box-sizing: border-box;/*ëª¨ë“  ìš”ì†Œë¥¼ width heightë¡œ ë„ˆë¹„, ë†’ì´ íŒ¨ë”©, ë³´ë” ìë™ìœ¼ë¡œ ì„¤ì •í•´ì¤Œ*/
        }
        p {
  		font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  		font-size: 16px;
  		color: #333;
 		margin: 2px;
		}

        ul {
            margin: 0;
            padding: 15px 15px 0 15px;
        }

        html,body {
            height: 100%;
            width: 100%;
            display: flex;/*í”Œë ‰ìŠ¤ ë°•ìŠ¤ ë ˆì´ì•„ì›ƒ*/
            justify-content: center;
            align-items: center;
        }

        .container {
            margin: 0 auto;
            border-radius: 5px;
            display: flex;
            justify-content: center;            
            width: 100%;
        }

        .chat {
            width: 100%;
            color: #434651;            
            border: 2px solid #EEEEEE  ;
            max-width: 430px;
            margin: 0 auto;

            border-radius: 15px;
            background-color: white;
            box-shadow: 0 14px 28px rgba(0, 0, 0, 0.25), 0 10px 10px rgba(0, 0, 0, 0.22);
        }

        .chat .chat-header {
            display: flex;
            padding: 5px 0 7px 0;
            border-bottom: 4px solid white;
            align-items: center;
            justify-content: center;
            background-color:#F4F4F4;
        }
        
        .chat .chat-header .chat-about {
            margin-right: 20px;
            font-size: 35px;            
            font-family: 'Do Hyeon';
            text-align: center;
        }
        
        .chat .chat-history {
            padding: 10px 0px 10px 0px;
            border-bottom: 5px solid white;
            scrollbar-width: none;/*íŒŒì´ì–´í­ìŠ¤ ìŠ¤í¬ë¡¤ë°” ì•ˆë³´ì´ê²Œ ì„¤ì •*/
            overflow-y: auto; /* ìŠ¤í¬ë¡¤ë°” ì„¤ì • ìë™ */
            height: 575px;
        }

        .chat-input-wrapper {
            position: relative;      /* ë‚´ë¶€ ìš”ì†Œ ìœ„ì¹˜ ê¸°ì¤€ */
            width: 100%;
            display: block;
        }
        .info img {
            display: flex;
            justify-content: flex-end;
            max-width: 200px;
            display: block;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        .btn-reset {
            background-color: #faffdd; /* ê¸°ë³¸ ë²„íŠ¼ ë°°ê²½ìƒ‰ */
            color: #000;               /* ê¸€ììƒ‰ */
            border: none;              /* í…Œë‘ë¦¬ ì œê±° */
            border-radius: 5px;        /* ëª¨ì„œë¦¬ ë‘¥ê¸€ê²Œ */
            padding: 5px 10px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-reset:hover,
        .btn-reset:focus,
        .btn-reset:active {
            background-color: #ccd1b3; /* ë§ˆìš°ìŠ¤ ì˜¬ë ¸ì„ ë•Œ ì‚´ì§ ì–´ë‘¡ê²Œ */
            outline: none;
        }
        #message-to-send {
            width: 100%;
            padding: 10px 20px; /* ì˜¤ë¥¸ìª½ ë²„íŠ¼ ê³µê°„ í™•ë³´ */
            box-sizing: border-box;       /* íŒ¨ë”© í¬í•¨ ë„ˆë¹„ ê³„ì‚° */
        }

        #send {
            position: absolute;
            right: 1px;
            top: 33%;
            transform: translateY(-50%);
            border: none;
            background-color: white;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 22px;
        }

        /* Chrome, Safari, Edge */
        .chat .chat-history::-webkit-scrollbar {
            display: none;
        }

        .chat .chat-history .my-message-data {
            text-align: right;
            font-size: 14px;
            margin-right: 10px;
        }

        .message-row {
            display: flex;
            justify-content: flex-end; /* ì˜¤ë¥¸ìª½ ì •ë ¬ */
            align-items: flex-end;
            gap: 5px; /* ì‹œê°„ê³¼ ë§í’ì„  ì‚¬ì´ ê°„ê²© */
            margin-top: 3px;
        }
        .chat .chat-history .message-data-time {
            display: inline-block; /* í•œ ì¤„ì— í‘œì‹œë˜ë„ë¡ */
            white-space: nowrap;   /* ì¤„ë°”ê¿ˆ ê¸ˆì§€ */
            font-size: 10px;
            color: #888;
            margin-bottom: 2px;
        }

        .message-data {
            display: flex;
            align-items: flex-end; /* ì„¸ë¡œ ë°©í–¥ ì•„ë˜ìª½ ì •ë ¬ */ 
        }

        .chat .chat-history .message {
            color: white;
            padding: 18px 20px;
            line-height: 22px;
            border-radius: 15px;
            margin-bottom: 0px;
            width: 100%;
            position: relative;/*afterì˜ ì ˆëŒ€ì  ê¸°ì¤€ì ì´ ë¼ì„œ after ì ìš©í•  ìˆ˜ ìˆê²Œ í•¨*/
        }


        .chat .chat-history .my-message {/*ë©”ì„¸ì§€ë¥¼ ì…ë ¥í–ˆì„ ë•Œ my-messageê°€ ë‚˜ì˜´*/
            display: inline-block; 
            background: #F1F1F1;
            padding: 5px 10px;
            font-size: 15px;    
            width: 90%;
            color : black;
            margin-bottom: 5px;            
        }

        .chat .chat-history .other-message {
            border: 1px solid #8A8A8A;
            padding: 5px 10px;
            font-size: 15px;
            width: 90%;
            color : black;
            margin-bottom: 2px;  
        }

        .chat .chat-history .other-message:after {
            border-bottom-color: #8A8A8A;
            left: 17%;
        }

        .message .other-message img {
            max-width: 250px;
            display: block;
            margin-top: 2px;
        }

        .chat-scroll-wrapper {
        position: relative;
        height: 100%;
        width: calc(100% - 10px); /* ì˜¤ë¥¸ìª½ì— ì—¬ìœ ê³µê°„ í™•ë³´ */
        overflow-y: scroll;
        padding-right: 10px;
        }

        /* ìŠ¤í¬ë¡¤ë°”ë¥¼ ì˜¤ë¥¸ìª½ì— ë³„ë„ë¡œ ìŠ¤íƒ€ì¼ë§ */
        .chat-scroll-wrapper::-webkit-scrollbar {
        width: 8px;
        }

        .chat-scroll-wrapper::-webkit-scrollbar-thumb {
        background-color: #bbb;
        border-radius: 4px;
        }

        .chat-scroll-wrapper::-webkit-scrollbar-track {
        background-color: transparent;
        }
        .previewImage {
        display: flex;          /* ê°€ë¡œ ì •ë ¬ */
        align-items: flex-end;    /* ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
        gap: 10px;           
        background-color: #faffdd;
        border-top-left-radius: 5px;
        border-top-right-radius: 5px;
        }
        .chat .chat-message {
            padding: 5px 15px 0px 15px;
            background-color:#EFEFEF;
        }

        .chat .chat-message textarea {
            width: 100%;
            border: none;
            padding: 10px 50px 10px 20px;
            font: 14px/22px "Lato", Arial, sans-serif;
            border-radius: 15px;
            resize: none;
            margin-bottom: 20px;
        }

        .chat .chat-message textarea:focus {
            outline: none;
            border: 2px solid #DAA520; /* ì§™ì€ í™©ê¸ˆìƒ‰ */
        }

        .align-right {
            text-align: right;
            float: right;
        }

        .float-right {
            float: right;/*ìš”ì†Œê°€ ë¶€ëª¨ì˜ ë°•ìŠ¤ ì•ˆì—ì„œ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ë¶™ìŒ*/
            margin-right: 10px;
        }

        .float-left {
            float: left;
            margin-left: 10px;
        }

        .clearfix:after {/*ë¶€ëª¨ê°€ ìì‹ì˜ floatì†ì„±ë•Œë¬¸ì— ë†’ì´ë¥¼ ìƒëŠ” ê²ƒì„ ë°©ì§€í•¨*/
            visibility: hidden;
            display: block;
            font-size: 0;
            content: " ";
            clear: both;
        }

        .face-image {
            position: relative;
            border-radius: 50%;
            width: 30px;
            height: 30px;
        }

        .face-initial {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #fff;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            font-family: 'NanumGothic', sans-serif;
            font-size: 14px;
            line-height: 1;
        }

         /* Added on 2023-08-22: Waiting animation styles */
         .loading-dots {
            display: inline-block;
            /* width: 30px; */
            height: 10px;
            text-align: center;
            font-size: 10px;
        }

        .loading-dots span {
            display: inline-block;
            width: 10px;
            height: 10px;
            margin: 0 2px;
            background-color: #555;
            border-radius: 50%;
            opacity: 0;/*íˆ¬ëª…ë„ ì„¤ì • ì™„ì „ íˆ¬ëª…*/
            animation: loading-dots 1.5s infinite;/*ì• ë‹ˆë©”ì´ì…˜ ë°˜ë³µ ì„¤ì •*/
            animation-timing-function: ease-in-out;
        }

        .loading-dots span:nth-child(1) { animation-delay: 0.1s; }/*loading-dotsì˜ ì²«ë²ˆì§¸ spanì—ë§Œ ì ìš©*/
        .loading-dots span:nth-child(2) { animation-delay: 0.3s; }
        .loading-dots span:nth-child(3) { animation-delay: 0.5s; }

        @keyframes loading-dots {/* í‚¤í”„ë ˆì„ìœ¼ë¡œ ì• ë‹ˆë©”ì´ì…˜ì„ ì •ì˜í•´ì„œ ìš”ì†Œì— ì ìš©í•¨*/
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }

        @keyframes blink {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0;
            }
        }



        .blink {
            animation-name: blink;
            animation-duration: 2s;
            animation-delay: 0.5s;
            animation-iteration-count: 50;
        }

        .drag-over {/*ë‚˜ì¤‘ì— í´ë¼ìŠ¤ ë¦¬ìŠ¤íŠ¸ì— ì†ì„± ë”í•´ì„œ ì²˜ë¦¬í•˜ê²Œ í•´ì¤Œ scriptë¡œ*/
            /*background: #b39198*/
            background-color: rgba(0, 0, 0, 0.5);
        }
        .user-info {
  		display: flex;
  		flex-direction: column; /* ì„¸ë¡œ ë°©í–¥ ì •ë ¬ */
  		align-items: flex-start; /* ì™¼ìª½ ì •ë ¬ (ì›í•˜ë©´ centerë„ ê°€ëŠ¥) */
		}

        #file {/*idê°€ fileì¼ë•Œ inputìš”ì†Œë¥¼ ìˆ¨ê¸°ê³  íŠ¹ì •í•œ ê¸°ëŠ¥ì„ ì¶”ê°€í•˜ê¸° ìœ„í•´ì„œ displayë¥¼ noneìœ¼ë¡œ ì§€ì •í•¨ inputì˜ íƒ€ì…ì´ íŒŒì¼ì´ë©´ ëˆ„ë¥´ë©´ íŒŒì¼íƒìƒ‰ê¸° ë‚˜ì˜¤ëŠ” ë²„íŠ¼ì´ ìƒì„±ë¨*/
            display: none;
        }
		.modal {
  		font-family: 'NanumGothic';
  		position: fixed;
  		top: 45%;
  		left: 50%;
  		transform: translate(-50%, -50%);
  		background-color: white;
  		border: 1px solid #ccc;
  		padding: 20px;
  		box-shadow: 0 0 10px rgba(0,0,0,0.3);
  		z-index: 1000;
  		border-radius: 5px;
  		width: 400px; /* ì ë‹¹í•œ ë„ˆë¹„ ì§€ì • */
  		display: flex;
  		flex-direction: column;
		}

		.modal-overlay {
  		display: none;
  		position: fixed;
  		top: 0; left: 0;
  		width: 100vw; height: 100vh;
  		background: rgba(0, 0, 0, 0.5);
  		justify-content: center;
  		align-items: center;
  		z-index: 1000;
		}
        
		.modal-header {
  		display: flex;
  		justify-content: space-between;
  		align-items: center;
  		margin-bottom: 15px;
		}

		.modal-header h2 {
  		margin: 0;
		}        
        
        #toggleSettingsBtn, #toggleMissionSettingsBtn {
  		padding: 5px 12px;
  		cursor: pointer;
		}
        
    	.modal-footer {
      	margin-top: 15px;
      	padding: 5px 10px;
      	background: white;
      	color: white;
      	border: none;
      	border-radius: 5px;
      	cursor: pointer;
        display: flex;
  		justify-content: flex-end;
  		gap: 10px;
    	}
		.modal-footer button {
        padding: 6px 12px;
        cursor: pointer;
        margin-top: 8px;
        margin-bottom: 8px;
        width: fit-content;
		}

        #ruleList li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 10px;
        }

        .rule-text {
        flex: 1;
        }

        .rule-actions .mission-actions {
        margin-left: 8px;
        }        

        .user {
  		color: #6a1b9a;
  		padding: 5px 5px;
		}

        #userList {
            display: flex;
            flex-wrap: wrap;
            gap: 10px; /* ìœ ì € ë²„íŠ¼ ì‚¬ì´ ê°„ê²© */
            margin-bottom: 20px; /* ë‹«ê¸° ë²„íŠ¼ê³¼ì˜ ê°„ê²© */
            justify-content: flex-start;
        }

        #userList button {
            width: fit-content;      /* ê¸€ì ê¸¸ì´ì— ë§ê²Œ ë²„íŠ¼ ë„ˆë¹„ */
            min-width: 60px;
            padding: 6px 12px;
            font-size: 15px;
            cursor: pointer;
        }
        .center-image {
            text-align: center;
        }
        .button-group button {
            display: flex;
            flex-direction: column;
            gap: 5px;
            font-size: 14px;
        }
        .chat-btn {
            margin-bottom: 10px; /* ì•„ë˜ ì—¬ë°± */
            display: inline-block;
            background-color: #f0f0f0; /* ê¸°ë³¸ ë²„íŠ¼ ë°°ê²½ìƒ‰ */
            color: #000;               /* ê¸€ììƒ‰ */
            border: none;              /* í…Œë‘ë¦¬ ì œê±° */
            border-radius: 5px;        /* ëª¨ì„œë¦¬ ë‘¥ê¸€ê²Œ */
            padding: 5px 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.2s;
        }
        #myprofile, #userManage {
            font-weight: bold;
            background-color: #6cb0f8;
            color:white;
        }

        /* ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë ¸ì„ ë•Œ */
        .chat-btn:hover,
        .chat-btn:focus,
        .chat-btn:active,
        #myprofile:hover{
            background-color: #e0e0e0; /* ë§ˆìš°ìŠ¤ ì˜¬ë ¸ì„ ë•Œ ì‚´ì§ ì–´ë‘¡ê²Œ */
            outline: none;
        }

    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.7.7/handlebars.min.js"></script>
</head>

<body onload="loadRules(); loadMissions();">
    <div class="container clearfix"><!-- ì»¨í…Œì´ë„ˆ ë°•ìŠ¤ì— ë””ìì¸í•  ìš”ì†Œë“¤ ì„¤ì •í•´ì„œ ë°°ì¹˜í•¨ -->
        <div class="chat">
            <div class="chat-header clearfix">
                <div class="button-group" style="display: flex; flex-direction: column; gap: 5px;">
                    <button onclick="openModal('modal1')">í•™ê¸‰ ê·œì¹™</button>
                    <button onclick="openModal('modal5')">ê³¼ì œ ëª©ë¡</button>
                </div>
                <img style="width:60px; border-radius:50px; margin-left:10px;" src="{{ url_for('static', filename='images/logo.png') }}?v=3" alt="moungbo" />
                <div class="chat-about" style="white-space: pre;">ìš°ë¦¬ë°˜ë³´ì•½</div>
                <div class="user-info">
                    <p>ğŸ‘¤: <span class="user" id="username">{{ username }}</span></p>
                	<p>ğŸª€: <span class="user" id="point">{{ point }}</span></p>
                    {% if role == "admin" %}
                    <button class="chat-btn" id="userManage" onclick="window.location.href='/usermanage'">ì±„íŒ…ë°© ê´€ë¦¬</button>
                    {% else %}
                    <button class="chat-btn" id="myprofile" onclick="window.location.href='/profile'">ë‚´ì •ë³´</button>
                    {% endif %}
                </div>

            </div> <!-- end chat-header -->

            <div class="chat-history">
            <div class="chat-scroll-wrapper">
                <ul style="list-style:none;">
                <!-- ì±„íŒ… ë©”ì‹œì§€ lië“¤ì´ ì—¬ê¸°ì— ë“¤ì–´ê° -->
                </ul>
            </div>
            </div> <!-- end chat-history -->

            <div class="previewImage">
                <span class=info></span>
                <button id="reset-upload" class="btn-reset" style="display:none">
                    <i class="previewReset"></i> â
                </button>
            </div>                         
            <div class="chat-message">                         
                <div class="chat-controls">
                    <!-- ì¼ë°˜ íŒŒì¼ ì²¨ë¶€ ë²„íŠ¼ -->
                    <label for="file-upload" class="chat-btn">ğŸ–¼ï¸/ğŸ—‚ï¸</label>
                    <input type="file" id="file-upload" style="display:none">  
                    <div class="chat-input-wrapper">
                        <textarea name="message-to-send" id="message-to-send" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”." rows="1"></textarea> 
                        <button id="send" class="chat-btn">â¡ï¸</button>
                    </div>
                </div>
            </div> <!-- end chat-message -->
        </div> <!-- end chat -->
    </div> <!-- end container -->
    <div class="modal-overlay" id="modal1" onclick="handleOverlayClick(event, 'modal1')">
  		<div class="modal" >
    		<div class="modal-header">
      			<h2>í•™ê¸‰ ê·œì¹™</h2>
      			<button id="toggleSettingsBtn" onclick="toggleEditMode()">ì„¤ì •</button>
    		</div>
    	<ul id="ruleList">
    	</ul>
    		<div class="modal-footer">
      			<button onclick="closeModal('modal1')">ë‹«ê¸°</button>
      			<button id="addRule" onclick="openModal('modal2')">ê·œì¹™ ì¶”ê°€</button>
    		</div>
  		</div>
	</div>

    <div class="modal-overlay" id="modal2" onclick="handleOverlayClick(event, 'modal2')">
  		<div class="modal">
    	<h2 class="modal-header">ê·œì¹™ ì¶”ê°€</h2>
    	<input
      	type="text"
      	id="newRuleInput"
      	placeholder="ìƒˆë¡œìš´ ê·œì¹™ ì…ë ¥"
      	onkeydown="moveToScoreEnter(event)"
      	style="width:100%; margin-bottom:10px;"
    	>

        <input
        type="number"
        id="newScoreInput"
        placeholder="ì ìˆ˜ ì…ë ¥"
        min="0"
        onkeydown="submitRuleEnter(event)"
        style="width:100%; margin-bottom:10px;"
        >

        <div class="modal-footer">
        	<button class="close-btn" onclick="handleRuleAddButtonClick()">ì¶”ê°€</button>
    		<button class="close-btn" onclick="closeModal('modal2')">ë‹«ê¸°</button>
        </div>
  		</div>
	</div>

    <div class="modal-overlay" id="modal3" onclick="handleOverlayClick(event, 'modal3')">
        <div class="modal">
            <h2 class="modal-header">ê·œì¹™ ìˆ˜ì •</h2>
            <input
            type="text"
            id="editRuleInput" 
        
            onkeydown="moveToEditScoreEnter(event)"
            style="width:100%; margin-bottom:10px;"
            > <!-- â˜… ê¸°ì¡´ newRuleInput â†’ editRuleInputë¡œ ë³€ê²½ -->
            
            <input
            type="number"
            id="editScoreInput"
            
            min="0"
            onkeydown="confirmEditEnter(event)"
            style="width:100%; margin-bottom:10px;"
            >
            <div class="modal-footer">
            <button class="close-btn" onclick="confirmEdit()">ìˆ˜ì •</button> <!-- ê¸°ì¡´ handleRuleAddButtonClick â†’ confirmEdit -->
            <button class="close-btn" onclick="closeModal('modal3')">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal4" onclick="handleOverlayClick(event, 'modal4')">
        <div class="modal">
            <h3 class="modal-header">ì ìˆ˜ ë¶€ì—¬</h3>
            <div id="userList"></div>

            <button class="close-btn" onclick="closeModal('modal4')">ë‹«ê¸°</button>
        </div>
    </div>

    <div class="modal-overlay" id="modal5" onclick="handleOverlayClick(event, 'modal5')">
  		<div class="modal" >
    		<div class="modal-header">
      			<h2>ì¼ì¼ ê³¼ì œ</h2>
      			<button id="toggleMissionSettingsBtn" onclick="toggleMissionEditMode()">ì„¤ì •</button>
    		</div>
    	<ul id="missionList">
    	</ul>
    		<div class="modal-footer">
      			<button onclick="closeModal('modal5')">ë‹«ê¸°</button>
      			<button id="addMission" onclick="openModal('modal6')">ê³¼ì œ ì¶”ê°€</button>
    		</div>
  		</div>
	</div>
    <!--  toggleEditModeê°€ ê·œì¹™ë¦¬ìŠ¤íŠ¸ë‘ ì—°ë™ë¨ ë¯¸ì…˜ì´ë‘ ì—°ë™ë˜ê²Œ ë°”ê¾¸ê¸° modal7 ì™„ì „íˆ ìˆ˜ì • -->
    <div class="modal-overlay" id="modal6" onclick="handleOverlayClick(event, 'modal6')">
  		<div class="modal">
    	<h2 class="modal-header">ê³¼ì œ ì¶”ê°€</h2>
    	<input
      	type="text"
      	id="newMissionInput"
      	placeholder="ìƒˆë¡œìš´ ê³¼ì œ ì…ë ¥"
      	onkeydown="moveToScoreEnter(event)"
      	style="width:100%; margin-bottom:10px;"
    	>

        <input
        type="number"
        id="newRewardInput"
        placeholder="ì ìˆ˜ ì…ë ¥"
        min="0"
        onkeydown="submitMissionEnter(event)"
        style="width:100%; margin-bottom:10px;"
        >

        <div class="modal-footer">
        	<button class="close-btn" onclick="handleMissionAddButtonClick()">ì¶”ê°€</button>
    		<button class="close-btn" onclick="closeModal('modal6')">ë‹«ê¸°</button>
        </div>
  		</div>
	</div>

    <div class="modal-overlay" id="modal7" onclick="handleOverlayClick(event, 'modal7')">
        <div class="modal">
            <h2 class="modal-header">ê³¼ì œ ìˆ˜ì •</h2>
            <input
            type="text"
            id="editMissionInput" 
        
            onkeydown="moveToEditScoreEnter(event)"
            style="width:100%; margin-bottom:10px;"
            > 
            
            <input
            type="number"
            id="editRewardInput"
            
            min="0"
            onkeydown="confirmEditEnter(event)"
            style="width:100%; margin-bottom:10px;"
            >
            <div class="modal-footer">
            <button class="close-btn" onclick="confirmMissionEdit()">ìˆ˜ì •</button> 
            <button class="close-btn" onclick="closeModal('modal7')">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <audio id="audioPlayer" controls style="display:none"></audio>
    <!-- í•¸ë“¤ë°” í…œí”Œë¦¿ ì‚¬ìš©í•´ì„œ ë©”ì„¸ì§€ë¥¼ ë™ì ìœ¼ë¡œ ëœë”ë§í•˜ê¸°ìœ„í•œ í…œí”Œë¦¿ jsê°€ ë™ì ìœ¼ë¡œ ë©”ì„¸ì§€ë¥¼ ì½ê³  ë¶™ì„ ë©”ì„¸ì§€ ë³€ìˆ˜ì— ë‹´ì•„ì„œ í…œí”Œë¦¿ì˜ ë§¤ê°œë³€ìˆ˜ë¡œ í•¨ìˆ˜ì‹¤í–‰í•¨ -->
    <script id="message-template" type="text/x-handlebars-template"> 
        {% raw %}
        <li class="clearfix">
            <div class="message-row align-right">
                <span class="message-data-time" >{{time}}</span>
                <div class="message my-message float-right">
                    {{messageOutput}}
    
                    <!-- if fileUUrlë¡œ í•œë²ˆ ë§‰ê³  isImageë¡œ ë¶„ë¥˜í•˜ê¸°-->
                    {{#if fileUrl}}
                        {{#if isImage}}
                            <img src="{{fileUrl}}" alt="Uploaded Image" style="max-width:250px; display:inline; margin:10px;">
                        {{else}}
                            <a href="{{fileUrl}}" download="{{fileName}}">{{fileName}} ë‹¤ìš´ë¡œë“œ</a>
                        {{/if}}
                    {{/if}}
                </div>
            </div>
      </li>
      {% endraw %}
    </script>
<!-- clearfix í´ë˜ìŠ¤ëŠ” ìì‹ìš”ì†Œì— ë§ê²Œ ë†’ì´ ìë™ìœ¼ë¡œ ë§ì¶°ì§, divìš”ì†ŒëŠ” displayì†ì„±ì´ ìë™ì ìœ¼ë¡œ blockì´ë¼ ì¶”ê°€ë˜ë©´ ì¤„ë°”ê¿ˆë¼ì„œ ë°°ì¹˜ë¨-->
    <script id="message-response-template" type="text/x-handlebars-template">
        {% raw %}
        <li class="clearfix">

            <div class="message-data">
                {{#if isBot}}
                    <img src="/static/images/trainer.png?v=1" class="face-image">
                {{else}}
                    <div class="face-initial" style="background-color: {{initialBg}};">{{initial}}</div>
                {{/if}}
                <span class="message-data-name">{{username}}</span>
            </div>
            <div class="message-row align-left">
                <div class="message other-message">
                    {{#if loading}}
                        <div class="loading-dots"><span></span><span></span><span></span></div>
                    {{else}}
                        {{{messageOutput}}}
                        {{#if fileUrl}}
                            {{#if isImage}}
                                <img src="{{fileUrl}}" alt="Uploaded Image" style="max-width:250px; display:inline; margin:10px;">
                            {{else}}
                                <a href="{{fileUrl}}" download="{{fileName}}">{{fileName}} ë‹¤ìš´ë¡œë“œ</a>
                            {{/if}}
                        {{/if}}
                    {{/if}}
                </div>
                <span class="message-data-time">{{time}}</span>
            </div>
        </li>
        {% endraw %}
    </script>
    <script>
        (function () {<!-- ì¦‰ì‹œì‹¤í–‰í•¨ìˆ˜ í•œë²ˆë§Œ ì‹¤í–‰ë¨ ì´ˆê¸°í™” ë‚´ìš© ì ìš©-->
            var initialMessages = {{ messages|tojson|safe }}; // ì„œë²„ì—ì„œ ì „ë‹¬ëœ ì´ˆê¸° ë©”ì‹œì§€ ë°ì´í„°
            var chat = {
                socket: null,
                messageToSend: '',//ë©”ì„¸ì§€ ì°½ì— í‘œì‹œí•˜ëŠ” í˜•íƒœë¡œ ë©”ì„¸ì§€, ë“œë¡­ëœ íŒŒì¼ ëŒ€í•´ì„œ ì²˜ë¦¬í•˜ëŠ” ë¡œì§
                init: function () {
                    this.cacheDOM();//ì—¬ê¸°ì„œ thisëŠ” chatì´ë¼ëŠ” ê°ì²´ì„ ê·¸ ê°ì²´ì— ëŒ€í•´ì„œ ì´ˆê¸°í™” ì„¤ì •í•¨ìˆ˜ document.querySelectorí•¨ìˆ˜ë¡œ ìë™ì ìœ¼ë¡œ ì„¤ì •í•´ì¤Œ sendë²„íŠ¼, ëŒ€í™”ë‚´ìš© ê°ì²´ë¡œ ê°€ì ¸ì˜´
                    this.bindEvents();//cacheDOMì—ì„œ ì„¤ì •í•œ ê²ƒìœ¼ë¡œ ì´ë²¤íŠ¸ë¦¬ìŠ¤ë„ˆë¡œ ì—°ê²°í•¨
                    this.initSocket(); // ì†Œì¼“ ì´ˆê¸°í™”

                    this.socket.emit('join', {'room_name': "{{ room_name }}" }); // ë°© ì°¸ì—¬ ì´ë²¤íŠ¸ ì „ì†¡
                },                
                // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë¥¼ chat ê°ì²´ ë‚´ì— í¬í•¨ì‹œí‚µë‹ˆë‹¤.
                initDragAndDrop: function () {
                    var self = this; // í˜„ì¬ chat ê°ì²´ë¥¼ self ë³€ìˆ˜ì— ì €ì¥
                    var dropArea = document.querySelector('body');
                    if (!dropArea) {
                        console.error('Drop area not found');
                        return;
                    }

                    // ë“œë˜ê·¸ ì˜¤ë²„ ì´ë²¤íŠ¸(íŒŒì¼ì„ ë“œë˜ê·¸í•´ì„œ ê°€ì ¸ì™”ì„ë•Œ ìƒˆ íƒ­ì—ì„œ ì—´ë¦¬ëŠ” í˜„ìƒ ë°‘ì— ìˆëŠ”preventDefaults í•¨ìˆ˜) ë°©ì§€ ë°”ê¹¥ ìŠ¤ì½”í”„ ì°¸ê³ í•˜ëŠ” í™”ì‚´í‘œí•¨ìˆ˜ ì‚¬ìš©í•¨ thisê°€ dropAreaë¡œ ì¸ì‹í•˜ëŠ” í˜„ìƒ ë°©ì§€
                    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                        dropArea.addEventListener(eventName, this.preventDefaults, false);
                    });

                      // ë“œë¡­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ inputìš”ì†Œì— ìë™ìœ¼ë¡œ ë¶™ê³  ë¯¸ë¦¬ë³´ê¸°ê°€ ì‹¤í–‰ë¨ ì—¬ê¸°ì„œ thisëŠ” chat ê°ì²´ë¥¼ ê°€ë¦¬í‚´ .bindê°€ ìˆì–´ì„œì„ í•¨ìˆ˜ì‹¤í–‰ì—ì„œ ë‚´ë¶€ ì ìœ¼ë¡œëŠ” dropAreaì°¸ê³ í•´ì•¼í•¨
                    dropArea.addEventListener('drop', this.handleDrop.bind(this), false);
                },
                preventDefaults: function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                },
               // Load initial messages passed from server and render them
                loadInitialMessages: function (initialMessages) {
                   // messages should be injected by Flask: messages = server-side list of dicts
                    if (!Array.isArray(initialMessages) || initialMessages.length === 0) return;
                    const currentUser = "{{ username }}";
 
                    initialMessages.forEach(m => {
                        const isFile = m.isFile;
                        if (isFile) {
                            const user = m.user;
                            const fileUrl = m.fileUrl;
                            const fileName = m.fileName;
                            const isImage = m.isImage;
                            const time = m.time;
                            const isUser = (user === currentUser);
                            this.renderFile({ user, time, fileUrl, isUser, isImage, fileName });
                        }
                        else {
                            const user = m.user;
                            const message = m.message;
                            const fileUrl = m.fileUrl || null;
                            const time = m.time;
                            const isUser = (user === currentUser);
                            this.render({ user, time, message, fileUrl, isUser});
                        }
                    });
                    this.scrollToBottom();
                },            
                handleDrop: function (e) {//íŒŒì¼ì„ ì°¨ë¡€ëŒ€ë¡œ ì—…ë¡œë“œí•˜ëŠ” í•¨ìˆ˜ ì´ë²¤íŠ¸ì— ëŒ€í•´ ì‹¤í–‰í•  í•¨ìˆ˜ë¥¼ ì„¤ì •í•¨
                    let dt = e.dataTransfer;
                    let files = dt.files;
            
                    this.handleFiles(files);
                },
            
                handleFiles: function (files) {
                    ([...files]).forEach(this.uploadFile.bind(this));//íŒŒì¼ì„ ë°°ì—´í˜•íƒœë¡œ ì—…ë¡œë“œí•¨
                },

                // Cache DOM elements
                cacheDOM: function () {
                    this.chatHistory = document.querySelector('.chat-scroll-wrapper') || document.querySelector('.chat-history');
                    this.button = document.querySelector('#send');
                    this.textarea = document.getElementById('message-to-send');
                    this.chatHistoryList = this.chatHistory.querySelector('ul');
                },
                // Bind events to elements ìœ„ì—ì„œ ì„¤ì •í•œ ê°ì²´ì— ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆì„ ë•Œ ì–´ë–¤ í•¨ìˆ˜ê°€ ì‹¤í–‰ë ì§€ ì„¤ì •í•¨
                bindEvents: function () {
                    this.button.addEventListener('click', this.addMessage.bind(this));
                    this.textarea.addEventListener('keyup', this.addMessageEnter.bind(this));
                    // íŒŒì¼ ì„ íƒ ì‹œ uploadFile(file)ì„ í˜¸ì¶œ -> ì´ë¯¸ì§€ë©´ preview, ì•„ë‹ˆë©´ ì„œë²„ ì—…ë¡œë“œ
                    document.getElementById('file-upload').addEventListener('change', (e) => {
                        const f = e.target.files && e.target.files[0];
                        if (f) this.uploadFile(f);
                    });
                    document.getElementById('reset-upload').addEventListener('click', () => {
                        const infoSpan = document.querySelector('.info');
                        if (infoSpan) infoSpan.innerHTML = '';
                        document.getElementById('file-upload').value = '';
                        document.getElementById('reset-upload').style.display = 'none';
                        // ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€ê°€ ìˆë‹¤ë©´ ì œê±°
                    });
                },
            
                //ì†Œì¼“ì„œë²„ì—ì„œ ë©”ì„¸ì§€ ë°›ì•˜ì„ ë•Œ ì‹¤í–‰
                initSocket: function () {
                    
                    this.socket = io(); // ì„œë²„ì™€ì˜ ì†Œì¼“ ì—°ê²° ì´ˆê¸°í™”
                    this.socket.on('message', ({ user, message, time, fileUrl }) => {
                        const currentUser = "{{ username }}"; // í…œí”Œë¦¿ ë³€ìˆ˜ë¡œ í˜„ì¬ ì‚¬ìš©ì ì´ë¦„ ì „ë‹¬
                        if (user === currentUser) return; // ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ëŠ” ë¬´ì‹œ
                        this.render({user:user, time, message, fileUrl}); // ì„œë²„ë¡œë¶€í„° ë©”ì‹œì§€ë¥¼ ë°›ìœ¼ë©´ ë Œë”ë§
                    });
                    this.socket.on('file', ({ user, fileUrl, fileName, isImage, time }) => {
                        const currentUser = "{{ username }}"; // í…œí”Œë¦¿ ë³€ìˆ˜ë¡œ í˜„ì¬ ì‚¬ìš©ì ì´ë¦„ ì „ë‹¬
                        const isUser = (user === currentUser);//ë‚´ê°€ë³´ë‚¸íŒŒì¼ì´ë©´ true, ì•„ë‹ˆë©´ false
                        this.renderFile({user:user, time, fileUrl, isUser, isImage, fileName});
                    });
                },
                
                //ì„œë²„ë¡œ emití•˜ëŠ” í•¨ìˆ˜
                emitMessage: function(user, message, imageUrl=null) {
                    const now = new Date();
                    const time = now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
                    this.socket.emit('message', {
                        user: user,
                        message: message,
                        time: time,
                        imageUrl: imageUrl
                    });
                },

                //renderê´€ë ¨ í•¨ìˆ˜
                stringToColor: function (str) {
                    if (!str) return '#777'; // ì´ë¦„ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ íšŒìƒ‰
                    let hash = 0;
                    for (let i = 0; i < str.length; i++) {
                        hash = str.charCodeAt(i) + ((hash << 5) - hash);
                        hash = hash & hash; // ì •ìˆ˜ ì˜¤ë²„í”Œë¡œ ë°©ì§€
                    }
                    let color = '#';
                    for (let i = 0; i < 3; i++) {
                        const value = (hash >> (i * 8)) & 0xFF; // RGB ê° ì±„ë„ ì¶”ì¶œ
                        color += ('00' + value.toString(16)).slice(-2);
                    }
                    return color;
                },
                // Render a new message isUserì´ trueì´ë©´ ì‚¬ìš©ìë©”ì„¸ì§€ falseì´ë©´ ìƒëŒ€ë°© ë©”ì„¸ì§€
                render: function ({user, time, message, fileUrl=null, isUser=false, isImage=true}) {
                    const name = (typeof user === 'object' && user !== null)
                        ? (user.name || user.username || '?')
                        : (user || '?');
                    const initial = name.slice(-2).toUpperCase() || '?';
                    const isBot = (user === "ì¹­ì°¬ë§¨"); // ë´‡ ì´ë¦„ì„ ì—¬ê¸°ì„œ ëª…ì‹œ. í•„ìš”í•˜ë©´ ì¡°ê±´ í™•ì¥
                    const initialBg = this.stringToColor(user || initial);

                    const templateId = isUser ? "#message-template" : "#message-response-template";//isUserê°€ trueì´ë©´ ì•ì— ê°’, falseë©´ ë’¤ì— ê°’ í• ë‹¹                    

                    const template = Handlebars.compile(document.querySelector(templateId).innerHTML);
                    //HTMLì—ì„œ templateIdê°ì²´ë¥¼ ì„ íƒí•´ì„œ ê·¸ ê°ì²´ë¥¼ ë¸Œë¼ìš°ì €ê°€ ì¸ì‹í•  ìˆ˜ ìˆëŠ” ì½”ë“œë¡œ ë°”ê¿”ì¤Œ handlebars ì‚¬ìš©í•˜ê² ë‹¤ëŠ” í‘œì‹œê°€ ìŠ¤í¬ë¦½íŠ¸ë¡œ htmlíŒŒì¼ì— ìˆì–´ì•¼í•¨ type="text/x-handlebars-template"

                    const context = {
                        username: user,
                        messageOutput: message,
                        fileUrl: fileUrl, 
                        time: time,
                        isImage: isImage,
                        initial: initial,
                        initialBg: initialBg,
                        isBot: isBot
                    };

                    let htmlString = template(context)
                    this.chatHistoryList.insertAdjacentHTML('beforeend', htmlString);

                    const lastItem = this.chatHistoryList.lastElementChild;
                    const imgs = lastItem ? lastItem.querySelectorAll('img') : [];
                    if (imgs.length > 0) {
                        const promises = Array.from(imgs).map(img => new Promise(resolve => {
                            if (img.complete) return resolve();
                            const onLoad = () => { img.removeEventListener('load', onLoad); resolve(); };
                            img.addEventListener('load', onLoad);
                            setTimeout(resolve, 3000);
                        }));
                        Promise.all(promises).then(() => {
                            this.scrollToBottom();
                            setTimeout(() => this.scrollToBottom(), 50);
                        });
                    } else {
                        this.scrollToBottom();
                    }
                },
                renderFile: function ({user, time, fileUrl, isUser, isImage, fileName}) {
                    const templateId = isUser ? "#message-template" : "#message-response-template";
                    const template = Handlebars.compile(document.querySelector(templateId).innerHTML);
                    const name = (typeof user === 'object' && user !== null)
                        ? (user.name || user.username || '?')
                        : (user || '?');                    
                    const initial = name.charAt(0).toUpperCase() || '?';
                    const isBot = (user === "ì¹­ì°¬ë§¨"); // ë´‡ ì´ë¦„ì„ ì—¬ê¸°ì„œ ëª…ì‹œ. í•„ìš”í•˜ë©´ ì¡°ê±´ í™•ì¥
                    const initialBg = this.stringToColor(user || initial);
                    const context = {
                        username: user,
                        fileUrl: fileUrl,
                        isImage: isImage,
                        fileName: fileName,
                        time: time,
                        initial: initial,
                        initialBg: initialBg,
                        isBot: isBot
                    };
                    let htmlString = template(context);
                    this.chatHistoryList.insertAdjacentHTML('beforeend', htmlString);

                    const lastItem = this.chatHistoryList.lastElementChild;
                    const imgs = lastItem ? lastItem.querySelectorAll('img') : [];
                    if (imgs.length > 0) {
                        const promises = Array.from(imgs).map(img => new Promise(resolve => {
                            if (img.complete) return resolve();
                            const onLoad = () => { img.removeEventListener('load', onLoad); resolve(); };
                            img.addEventListener('load', onLoad);
                            setTimeout(resolve, 3000);
                        }));
                        Promise.all(promises).then(() => {
                            this.scrollToBottom();
                            setTimeout(() => this.scrollToBottom(), 50);
                        });
                    } else {
                        this.scrollToBottom();
                    }
                },


                previewImage: function (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const imgPreview = document.createElement('img');
                        imgPreview.src = e.target.result;
                        const infoSpan = document.querySelector('.info');
                        infoSpan.innerHTML = '';
                        infoSpan.appendChild(imgPreview);
                        const resetBtn = document.querySelector('#reset-upload');
                        if (resetBtn) {
                            resetBtn.style.display = 'inline-block'; // ë˜ëŠ” 'block'
                        }
                    };
                    reader.readAsDataURL(file);
                },

                // Add a message and its response
                addMessage: async function () {
                    const now = new Date();
                    const time = now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
                    const user = '{{ username }}';
                    
                    const imgInput = document.getElementById('file-upload');
                    const selectedImage = imgInput && imgInput.files && imgInput.files[0];
                    if (selectedImage) {
                        this.fileUpload();//ì´ë¯¸ì§€ ì„ íƒë˜ì–´ ìˆìœ¼ë©´ íŒŒì¼ì—…ë¡œë“œ í•¨ìˆ˜ ì‹¤í–‰
                        document.querySelector('.info').innerHTML = '';
                    }

                    const formData = new FormData();//FormDataëŠ” ì„œë²„ì— ë³´ë‚¼ ë°ì´í„°ë¥¼ ë”•ì…”ë„ˆë¦¬ í˜•ì‹ìœ¼ë¡œ ì¶”ê°€í•  ìˆ˜ ìˆê²Œ í•˜ëŠ” ê°ì²´ë¥¼ ë§Œë“¤ì–´ì£¼ëŠ” í•¨ìˆ˜ì„
                    this.messageToSend = this.textarea.value.trim();//textareaì˜ domìš”ì†Œì— ì…ë ¥ê°’ì„ ê³µë°± ì œê±°í•´ì„œ ê°€ì ¸ì˜´
                    if (this.messageToSend){
                        this.render({user:user, time, message: this.messageToSend, isUser: true});//ë‚´ ë©”ì„¸ì§€ëŠ” ëœë” í›„ emit
                        this.emitMessage(user, this.messageToSend);
                        this.textarea.value = '';
                    	}//renderí•¨ìˆ˜ë¡œ ë‚´ê°€ ë³´ë‚¸ ë©”ì„¸ì§€ë¥¼ ë¨¼ì € ì±„íŒ…ì°½ì— ë„ì›Œì¤Œ
                    if (this.messageToSend.startsWith("!")){
                    	showBubblePromise = this.showBubbleAfterSeconds(500)
                    	waitPromise = this.waitSeconds(1500)
                    	await showBubblePromise //ë‹µë³€ì´ ì¶œë ¥ë˜ê³  ë²„ë¸”ë§ì´ ë°œìƒë˜ëŠ” í˜„ìƒ ì œì–´
                    	await waitPromise  //ìµœì†Œ 2ì´ˆëŠ” ë²„ë¸”ë§
                		if (this.messageToSend === "!ë˜ì ¸") {
                        	await this.catchPokemon(user, -500);
                    		}
                        else if (this.messageToSend.startsWith("!ì „ë‹¬")) {
                            const give = this.messageToSend.split(" ")
						    if (give.length < 3) {
                            
					        this.emitMessage("ì¹­ì°¬ë§¨", "ì „ë‹¬í•  ì‚¬ìš©ì ì´ë¦„ê³¼ í¬ì¸íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”. ì˜ˆ: !ì „ë‹¬ ì´ë¦„ 100");
					        return;
						    }                            
                            const targetName = give[1]
    						const givingPoint = Number(give[2])

    						if (!/^\d+$/.test(givingPoint)) {
        						this.emitMessage("ì¹­ì°¬ë§¨", "ìœ íš¨í•œ í¬ì¸íŠ¸ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”. ì˜ˆ: !ì „ë‹¬ ì´ë¦„ 100");
        						return;
    						}
                            const res = await fetch("/give_point", {
    							method: "POST",
    							headers: { "Content-Type": "application/json" },
    							body: JSON.stringify({
        						to: targetName,
        						amount: givingPoint,  // ì›í•˜ëŠ” í¬ì¸íŠ¸ ì–‘ì„ ì¶”ê°€
                                admin: "{{ room_name }}" // í…œí”Œë¦¿ ë³€ìˆ˜ë¡œ í˜„ì¬ ì±„íŒ…ë°© ê´€ë¦¬ì ì´ë¦„ ì „ë‹¬
    								})
								});
        					const result = await res.json();
        					if (result.success) {
            					this.emitMessage("ì¹­ì°¬ë§¨", result.message);  // ì„±ê³µ ë©”ì‹œì§€ ì¶œë ¥
            					document.getElementById("point").innerText = result.new_point;
        					} 
                        	else {
            					this.emitMessage("ì¹­ì°¬ë§¨", result.message);  // ì‹¤íŒ¨ ë©”ì‹œì§€ ì¶œë ¥
        						}
                    		}
                    	else {
                            this.emitMessage("ì¹­ì°¬ë§¨", "ê·¸ê±´ ì•Œ ìˆ˜ ì—†ëŠ” ë§ì´ì•¼.")
                        	}
                    document.getElementById('file-upload').value = ''; // ì´ë¯¸ì§€ í•„ë“œ ì´ˆê¸°í™” ì¡´ì¬í•  ë•Œë¥¼ ì¡°ê±´ìœ¼ë¡œ ì‹¤í–‰í•˜ëŠ” ê²½ìš°ë„ ìˆê³  ë‹¤ì‹œ ê°™ì€ ì´ë¯¸ì§€ ì—…ë¡œë“œí•´ë„ changeê°€ ë°œìƒí•˜ì§€ ì•ŠëŠ” ê²½ìš°ë„ ìˆìŒ
                	}
                },
                // Add a message when the Enter key is pressed
                addMessageEnter: function (event) {
                    if (event.keyCode === 13) {//ì—”í„° í‚¤ì½”ë“œ ì—”í„° ëˆŒë €ì„ ë•Œ addMessage ì‹¤í–‰
                        this.addMessage();
                    }   
                },

                showResponse:  function (message) {
                    this.scrollToBottom();
                    const templateId = "#message-response-template";//idê°€ ì´ê²ƒì´ê³  <script type="text/x-handlebars-template">ì¸ ìš”ì†Œë¥¼ ì°¾ì•„ì„œ í…œí”Œë¦¿ ì½”ë“œë¥¼ templateSourceì— ì €ì¥í•¨
                    let templateSource = document.querySelector(templateId).innerHTML;
                    const template = Handlebars.compile(templateSource);//í…œí”Œë¦¿ì„ ê°ì²´í™”í•¨
                    const context = {
                        messageOutput: message,
                        time: this.getCurrentTime()
                    };
                    let htmlString = template(context);//ë©”ì„¸ì§€ì— í…œí”Œë¦¿ì„ ì ìš©í•¨
                    
    
                    document.querySelector('.chat-history > ul > li:last-child').innerHTML = htmlString//ì±„íŒ…ì°½ì— ìˆëŠ” htmlêµ¬ì¡° ì¤‘ ë§ˆì§€ë§‰ì— ë©”ì„¸ì§€ ë°ì´í„°ë¥¼ ë„ì›€ ë™ì ìœ¼ë¡œ htmlì˜ êµ¬ì¡°ì— ì¶”ê°€í•œë‹¤ëŠ” ì½”ë“œì„
                    this.scrollToBottom();                    
                },     
                 // ì¼ì • ì‹œê°„(seconds) ê²½ê³¼ ì‹œì ì„ ì•Œë¦´ ìˆ˜ ìˆëŠ” ë¹„ë™ê¸° í•¨ìˆ˜
                waitSeconds: async function (delay) {
                    return new Promise(resolve => {
                        this.waitTime = 0;//ê¸°ë‹¤ë¦¼ì„ êµ¬í˜„
                        setTimeout(() => {
                            resolve();
                        }, delay + this.waitTime);//ì²˜ìŒ ì„¤ì •í•œ ì‹œê°„ ë§Œí¼ ê¸°ë‹¤ë ¸ë‹¤ê°€ ë‹¤ìŒì—ëŠ” delayë§Œí¼ë§Œ ê¸°ë‹¤ë ¸ë‹¤ ë‹¤ìŒ ì½”ë“œ í˜¸ì¶œí•¨
                    });
                },
                showBubbleAfterSeconds: async function (delay) {
                    return new Promise(resolve => {
                        setTimeout(() => {
                            const templateId = "#message-response-template";//ì„¤ì •í•œ í…œí”Œë¦¿ ê°€ì ¸ì˜¤ëŠ” ì½”ë“œ
                            const template = Handlebars.compile(document.querySelector(templateId).innerHTML);
                            const context = {
                                loading: true,//context ë‚´ìš©ì´ ë¡œë”©ì¤‘ì´ë¼ëŠ” ë‚´ìš©ì„
                                time: this.getCurrentTime()
                            };
                            // ë¬¼ë°©ìš¸ ì• ë‹ˆë©”ì´ì…˜ì„ ì‹œì‘í•©ë‹ˆë‹¤.
                            var loadingHtml = template(context);
                            this.chatHistoryList.insertAdjacentHTML('beforeend', loadingHtml);//chathistorylistì˜ ë§ˆì§€ë§‰ì— ë¡œë”©ì¤‘ì„ ì¶”ê°€í•¨
                            this.scrollToBottom();
                            // ë§ˆì§€ë§‰ìœ¼ë¡œ ì¶”ê°€ëœ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
                            const lastBubble = this.chatHistoryList.lastElementChild;

                            // ì¼ì • ì‹œê°„ ë’¤ ì œê±°
                            setTimeout(() => {
                                if (lastBubble) lastBubble.remove();
                            }, 1000); // 2ì´ˆ ë’¤ ì œê±°

                            resolve();
                        }, delay);
                    });
                },
                throwPokemon: async function () {
                    const res = await fetch('/random_character');
                    const data = await res.json();
                    const selectedImage = data.file;
                    const name = selectedImage.split('.')[0];
                    const imageUrl = `/static/characters/${selectedImage}`;
                    const message = `${name} ì¡ì•˜ë‹¤!!`;
                    this.emitMessage("ì¹­ì°¬ë§¨", message, imageUrl);
                },
                
                catchPokemon: async function(username, amount) {
                    const admin = "{{ room_name }}"; // í…œí”Œë¦¿ ë³€ìˆ˜ë¡œ í˜„ì¬ ì±„íŒ…ë°© ê´€ë¦¬ì ì´ë¦„ ì „ë‹¬
                    const res = await fetch("/catchpokemon", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ username, amount, admin })//adminì¶”ê°€
                	});
                    const result = await res.json();
                    if (result.success) {
                        await this.throwPokemon();
                        document.getElementById("point").innerText = result.new_point;
                    }
                    else {
                        this.emitMessage("ì¹­ì°¬ë§¨", result.message);
                    }
                },
 

                // Scroll to the bottom of the chat history
                scrollToBottom: function () {
                    requestAnimationFrame(() => {
                        this.chatHistory.scrollTop = this.chatHistory.scrollHeight;
                    });                
                },
                // Get the current time
                getCurrentTime: function () {
                    let currentDate = new Date();
                    return currentDate.toLocaleDateString('ko-KR', { month: 'long', day: 'numeric' });
                    
                },
                
                //inputìš”ì†Œì— íŒŒì¼ì„ ê°•ì œë¡œ ë„£ì–´ì£¼ëŠ” í•¨ìˆ˜
                uploadFile: function (file) {
                    const MAX_SIZE = 500 * 1024 * 1024; // 500MB

                    if (file.size > MAX_SIZE) {
                        alert("500MB ì´í•˜ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                        return;
                    }
                    var fileInput = document.getElementById('file-upload'); 
                    var dataTransfer = new DataTransfer(); 
                    dataTransfer.items.add(file); 
                    fileInput.files = dataTransfer.files;
                    if (file.type.startsWith('image/')) {
                        this.previewImage(file);
                        return;//ì´ë¯¸ì§€ íŒŒì¼ì´ë©´ ë¯¸ë¦¬ë³´ê¸° í•¨ìˆ˜ ì‹¤í–‰ ì¸í’‹ ì´ˆê¸°í™” ì•„ì§ ì•ˆí•¨
                    }
                    this.fileUpload();
                },

                emitFile: function(fileUrl, fileName) {
                    const now = new Date();
                    const time = now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
                    const username = "{{ username }}";
                    const isImage = /\.(jpg|jpeg|png|gif|webp)$/i.test(fileName); // í™•ì¥ìë¡œ ì´ë¯¸ì§€ ì—¬ë¶€ íŒë‹¨
                    this.socket.emit('file', {
                        user: username,
                        time: time,
                        fileUrl: fileUrl,
                        fileName: fileName,
                        isImage: isImage
                    });
                },
                // íŒŒì¼ ì „ë‹¬ í•¨ìˆ˜
                fileUpload: function() {                
                    this.scrollToBottom();
                    const uploadedFile = document.getElementById('file-upload').files[0];
                    if (uploadedFile) {
                        username = "{{ username }}";
                        const formData = new FormData();//ì„œë²„ì— íŒŒì¼ ë³´ë‚´ì„œ urlë§Œë“¤ì–´ì„œ ë°›ì•„ì˜¤ê¸°
                        formData.append("file", uploadedFile);
                        formData.append("username", "{{ username }}");
                        formData.append("admin", "{{ room_name }}");//í…œí”Œë¦¿ ë³€ìˆ˜ë¡œ í˜„ì¬ ì±„íŒ…ë°© ê´€ë¦¬ì ì´ë¦„ ì „ë‹¬
                        fetch("/fileUpload", { method: "POST", body: formData })
                            .then(res => res.json())
                            .then(data => {
                                if (data.success) {
                                    const now = new Date();
                                    const time = now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
                                    const fileUrl = data.file_url; // âœ… ì„œë²„ì—ì„œ ë°›ì€ ì§„ì§œ URL
                                    const myFileUrl = URL.createObjectURL(uploadedFile);//ë¸Œë¼ìš°ì €ê°€ ëœë”ë§ í•  ìˆ˜ ìˆë„ë¡ ì„ì‹œë¡œ ì´ë¯¸ì§€ urlì„ ë§Œë“¤ì–´ ì¤Œ
                                    this.emitFile(fileUrl, uploadedFile.name);
                                }
                            });
                        document.getElementById('file-upload').value = '';//ì¸í’‹ ì´ˆê¸°í™”
                    }
                },
            };
            chat.init();//ì±„íŒ…ê¸°ëŠ¥ ì´ˆê¸°í™” ì‹¤í–‰, ë“œë˜ê·¸ì•¤ë“œë¡­ê¸°ëŠ¥ ì„¤ì • ì‹¤í–‰
            chat.initDragAndDrop();
            chat.loadInitialMessages(initialMessages);//ì´ˆê¸°ë©”ì„¸ì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤í–‰
        })();

        function openModal(id) {
    	    document.getElementById(id).style.display = "flex";
  		}

  		function closeModal(id) {
    		document.getElementById(id).style.display = "none";
            currentEditItem = null;
            if (id === "modal1" && editMode) {
                editMode = false;
                const ruleItems = document.querySelectorAll("#ruleList li");
                ruleItems.forEach((item) => {
                const actions = item.querySelector(".rule-actions");
                if (actions) actions.remove();
                });
            }
            else if (id === "modal5" && editMode) {
                editMode = false;
                const missionItems = document.querySelectorAll("#missionList li");
                missionItems.forEach((item) => {
                const actions = item.querySelector(".mission-actions");
                if (actions) actions.remove();
                });
            }
  		}
		function handleOverlayClick(event, modalId) {//ë°°ê²½ì„ í´ë¦­í–ˆì„ ë•Œ í™”ë©´ ë‹«ê¸°
  			if (event.target === event.currentTarget) {
    			closeModal(modalId);
  			}
		}
        const role = "{{ role }}";
        if (role !== "admin") {
            document.getElementById("addRule").style.display = "none";
            document.getElementById("addMission").style.display = "none";
            document.getElementById("toggleSettingsBtn").style.display = "none";
            document.getElementById("toggleMissionSettingsBtn").style.display = "none";
        }
        function submitRule(ruleInput, scoreInput) {//ì„œë²„ì— ê·œì¹™ ì œì¶œ
          const newRule = ruleInput.value.trim();
          const newScore = scoreInput.value.trim();
          if (newRule === "" || newScore === "") return;

          const ruleList = document.getElementById("ruleList");
          const newItem = document.createElement("li");

          const textSpan = document.createElement("span");
          textSpan.className = "rule-text";
          textSpan.textContent = `${newRule} (${newScore}ì )`;
          newItem.appendChild(textSpan);   //liì— textì íŒ span ì¶”ê°€

          ruleList.appendChild(newItem);
          ruleInput.value = "";
          scoreInput.value = "";
          closeModal("modal2");

          fetch("/add_rule", {//ì„œë²„ì— ì „ë‹¬
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ content: newRule, score: Number(newScore) })
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
                newItem.setAttribute("data-id", data.id); // â† â˜… idë¥¼ liì— ì €ì¥
                loadRules();
            }
          });
        }

        function submitMission(missionInput, rewardInput) {//ì„œë²„ì— ë¯¸ì…˜ ì œì¶œ
          const newMission = missionInput.value.trim();
          const newReward = rewardInput.value.trim();
          if (newMission === "" || newReward === "") return;

          const missionList = document.getElementById("missionList");
          const newItem = document.createElement("li");

          const textSpan = document.createElement("span");
          textSpan.className = "mission-text";
          textSpan.textContent = `${newMission} (${newReward}ì )`;
          newItem.appendChild(textSpan);   //liì— textì íŒ span ì¶”ê°€

          // âœ… ì²´í¬ë°•ìŠ¤ ì¶”ê°€dx
          const checkbox = document.createElement("input");
        
          checkbox.type = "checkbox";        
          checkbox.className = "mission-check";        

          newItem.appendChild(checkbox);

          missionList.appendChild(newItem);
          missionInput.value = "";
          rewardInput.value = "";
          closeModal("modal6");

          fetch("/add_mission", {//ì„œë²„ì— ì „ë‹¬
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ content: newMission, reward: Number(newReward) })
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
                const missionId = data.id;
                newItem.setAttribute("data-id", missionId); // â† â˜… idë¥¼ liì— ì €ì¥
                checkbox.dataset.missionId = missionId; // ì„œë²„ì—ì„œ ì‹ë³„ìš©        
                checkbox.addEventListener("change", async function () {        
                    const isChecked = checkbox.checked; 

                    // ì„œë²„ì— ì²´í¬ ìƒíƒœ ì „ì†¡
                    if ("{{username}}" !== "{{room_name}}") {// ìœ ì €ë§Œ ì„œë²„ ì „ì†¡ ê°€ëŠ¥          
                    const response = await fetch("/update_checked", {

                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                mission_id: missionId,
                                username: "{{ username }}",
                                checked: isChecked,
                                admin: "{{ room_name }}"
                        }),
                    });
                    }
                });
                loadMissions();
            }
          });
        }

        let currentEditItem = null;//li ì €ì¥ìš© ë³€ìˆ˜        
        let editMode = false;

        //ê·œì¹™ ìˆ˜ì • í•¨ìˆ˜
        function toggleEditMode() {//ìˆ˜ì •ëª¨ë“œ ìˆ˜ì •í•  ë•Œ í•„ìš”í•œ ì½”ë“œê°€ ìˆìŒ
        editMode = !editMode;//ìˆ˜ì •,ì‚­ì œëª¨ë“œì¼ë•Œë§Œ ë²„íŠ¼ì´ ìƒˆë¡œ ìƒì„±ë¼ì„œ í‘œì‹œë˜ê²Œ
        const ruleItems = document.querySelectorAll("#ruleList li");//liê°ê° ë¶ˆëŸ¬ì˜¤ê¸° liì˜ span-text, span-button

        ruleItems.forEach((item) => {
            if (editMode) {
            const actions = document.createElement("span");
            actions.className = "rule-actions";//ê°ê°ì˜ spanì— í´ë˜ìŠ¤ëª… ì§€ì •

            // ìˆ˜ì • ë²„íŠ¼
            const editBtn = document.createElement("button");
            editBtn.textContent = "ìˆ˜ì •";
            editBtn.className = "edit-btn";
            editBtn.onclick = () => editRule(item);//ìˆ˜ì • ê¸°ëŠ¥ì€ ë”°ë¡œ ë°‘ì— í•¨ìˆ˜ë¡œ ë¹¼ë‘ 

            // ì‚­ì œ ë²„íŠ¼
            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "ì‚­ì œ";
            deleteBtn.className = "delete-btn";
            deleteBtn.onclick = () => {
            const id = item.dataset.id;
            fetch('/delete_rule', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id })
            }).then(res => res.json())
                .then(data => {
                if (data.success) {
                    item.remove();
                } else {
                    alert('ì‚­ì œ ì‹¤íŒ¨');
                }
                });
                document.getElementById("toggleSettingsBtn").click();
            };

            const giveScoreBtn = document.createElement("button");
            giveScoreBtn.textContent = "ğŸ§‘";
            giveScoreBtn.className = "give-score-btn";
            giveScoreBtn.onclick = () => openScoreModal(item);

            // ì¤‘ë³µ ì¶”ê°€ ë°©ì§€
            actions.appendChild(giveScoreBtn);
            actions.appendChild(editBtn);
            actions.appendChild(deleteBtn);
            if (!item.querySelector(".rule-actions")) item.appendChild(actions);

            } else {
            // í¸ì§‘ ëª¨ë“œ í•´ì œ ì‹œ ë²„íŠ¼ ë¬¶ìŒ ì „ì²´ ì œê±°
            const actions = item.querySelector(".rule-actions");
            if (actions) actions.remove();
            }
        });
        }

        function editRule(item) {
            currentEditItem = item;//ë³€ìˆ˜ë¥¼ ìƒˆë¡œ ì •ì˜í•œ ê²Œ ì•„ë‹ˆë¼ì„œ ì „ì—­ë³€ìˆ˜ì˜ ê°’ì— ì ‘ê·¼í•œ ê±°ì„
            
            const textSpan = item.querySelector(".rule-text");
            const fullText = textSpan.textContent.trim();

            // "ê·œì¹™ ë‚´ìš© (5ì )" í˜•íƒœë¼ë©´ ì ìˆ˜ ë¶„ë¦¬í•˜ê¸°
            const match = fullText.match(/^(.*)\s\((\d+)ì \)$/);

            let oldContent = fullText;
            let oldScore = "";

            if (match) {
                oldContent = match[1]; // ê·œì¹™ ë‚´ìš©
                oldScore = match[2];   // ì ìˆ˜ (ë¬¸ìì—´)
            }

            const contentInput = document.getElementById("editRuleInput");
            const scoreInput = document.getElementById("editScoreInput");

            // placeholder ëŒ€ì‹  ë°”ë¡œ valueë¡œ ë„£ëŠ” ê²Œ ë” UX ì¢‹ìŒ
            contentInput.value = oldContent;
            scoreInput.value = oldScore;

            document.getElementById("modal3").style.display = "flex"; // ëª¨ë‹¬ ë„ìš°ê¸°
        }

        function confirmEdit() {
            const contentInput = document.getElementById("editRuleInput");
            const scoreInput = document.getElementById("editScoreInput");
            const newText = contentInput.value.trim();
            const newScore = scoreInput.value.trim();

            if (!newText) {
                alert("ìˆ˜ì •í•  ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }
            if (newScore === "" || isNaN(newScore)) {
                alert("ìœ íš¨í•œ ì ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }
            const item = currentEditItem;
            const ruleId = item.dataset.id;
            const textSpan = item.querySelector(".rule-text");

            fetch("/update_rule", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id: ruleId, content: newText, score: Number(newScore) }),
            })
            .then(res => res.json())
            .then(result => {
                if (result.success) {
                    textSpan.textContent = `${newText} (${newScore}ì )`;
                    document.getElementById("toggleSettingsBtn").click(); // ì„¤ì • ë²„íŠ¼ ìë™ ë‹«ê¸°
                    closeModal("modal3");
                } else {
                    alert("ìˆ˜ì • ì‹¤íŒ¨");
                }
            });
        }

        //ì ìˆ˜ ë¶€ì—¬ ëª¨ë‹¬ ì—´ê¸° í•¨ìˆ˜
        function openScoreModal(item) {
            // ì„ íƒí•œ ê·œì¹™ ì €ì¥
            currentEditItem = item;
            const modal = document.getElementById('modal4');
            modal.style.display = 'flex';

            const userListDiv = document.getElementById('userList');
            userListDiv.innerHTML = ''; // ê¸°ì¡´ ë²„íŠ¼ ì œê±°

            // ì„œë²„ì—ì„œ ìœ ì € ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            fetch("/get_users")
                .then(res => res.json())
                .then(users => {
                    users.forEach(user => {
                        const btn = document.createElement("button");
                        btn.textContent = user.username;
                        btn.onclick = async () => {
                            const ruleId = currentEditItem.dataset.id;       // liì— ì €ì¥ëœ id
                            const res = await fetch("/give_score", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({
                                    ruleId: ruleId,
                                    user: user.username
                                })
                            });

                            const data = await res.json();
                            if (data.success) {
                                alert(`${user.username}ì—ê²Œ ${data.score}ì  ë¶€ì—¬ ì™„ë£Œ`);
                            } else {
                                alert("ì ìˆ˜ ë¶€ì—¬ ì‹¤íŒ¨");
                            }
                            modal.style.display = 'none';
                        };

                        userListDiv.appendChild(btn);
                    });
                });
        }

        //ë¯¸ì…˜ ê´€ë ¨ ì„¤ì • í•¨ìˆ˜
        function toggleMissionEditMode() {//ìˆ˜ì •ëª¨ë“œ ìˆ˜ì •í•  ë•Œ í•„ìš”í•œ ì½”ë“œê°€ ìˆìŒ
        editMode = !editMode;//ìˆ˜ì •,ì‚­ì œëª¨ë“œì¼ë•Œë§Œ ë²„íŠ¼ì´ ìƒˆë¡œ ìƒì„±ë¼ì„œ í‘œì‹œë˜ê²Œ
        const missionItems = document.querySelectorAll("#missionList li");//liê°ê° ë¶ˆëŸ¬ì˜¤ê¸° liì˜ span-text, span-button

        missionItems.forEach((item) => {
            if (editMode) {
            const actions = document.createElement("span");
            actions.className = "mission-actions";//ê°ê°ì˜ spanì— í´ë˜ìŠ¤ëª… ì§€ì •

            // ìˆ˜ì • ë²„íŠ¼
            const editBtn = document.createElement("button");
            editBtn.textContent = "ìˆ˜ì •";
            editBtn.className = "edit-btn";
            editBtn.onclick = () => editMission(item);//ìˆ˜ì • ê¸°ëŠ¥ì€ ë”°ë¡œ ë°‘ì— í•¨ìˆ˜ë¡œ ë¹¼ë‘ 

            // ì‚­ì œ ë²„íŠ¼
            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "ì‚­ì œ";
            deleteBtn.className = "delete-btn";
            deleteBtn.onclick = () => {
            const id = item.dataset.id;
            fetch('/delete_mission', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id })
            }).then(res => res.json())
                .then(data => {
                if (data.success) {
                    item.remove();
                } else {
                    alert('ì‚­ì œ ì‹¤íŒ¨');
                }
                });
                document.getElementById("toggleMissionSettingsBtn").click();
            };

            // ì¤‘ë³µ ì¶”ê°€ ë°©ì§€
            actions.appendChild(editBtn);
            actions.appendChild(deleteBtn);
            if (!item.querySelector(".mission-actions")) item.appendChild(actions);

            }
            else {
            // í¸ì§‘ ëª¨ë“œ í•´ì œ ì‹œ ë²„íŠ¼ ë¬¶ìŒ ì „ì²´ ì œê±°
            const actions = item.querySelector(".mission-actions");
            if (actions) actions.remove();
            }
        });
        }

        function editMission(item) {
            currentEditItem = item;//ë³€ìˆ˜ë¥¼ ìƒˆë¡œ ì •ì˜í•œ ê²Œ ì•„ë‹ˆë¼ì„œ ì „ì—­ë³€ìˆ˜ì˜ ê°’ì— ì ‘ê·¼í•œ ê±°ì„
            
            const textSpan = item.querySelector(".mission-text");
            const fullText = textSpan.textContent.trim();

            // "ê·œì¹™ ë‚´ìš© (5ì )" í˜•íƒœë¼ë©´ ì ìˆ˜ ë¶„ë¦¬í•˜ê¸°
            const match = fullText.match(/^(.*)\s\((\d+)ì \)$/);

            let oldContent = fullText;
            let oldReward = "";

            if (match) {
                oldContent = match[1]; // ê·œì¹™ ë‚´ìš©
                oldReward = match[2];   // ì ìˆ˜ (ë¬¸ìì—´)
            }

            const contentInput = document.getElementById("editMissionInput");
            const rewardInput = document.getElementById("editRewardInput");

            // placeholder ëŒ€ì‹  ë°”ë¡œ valueë¡œ ë„£ëŠ” ê²Œ ë” UX ì¢‹ìŒ
            contentInput.value = oldContent;
            rewardInput.value = oldReward;

            document.getElementById("modal7").style.display = "flex"; // ëª¨ë‹¬ ë„ìš°ê¸°
        }

        function confirmMissionEdit() {
            const contentInput = document.getElementById("editMissionInput");
            const rewardInput = document.getElementById("editRewardInput");
            const newText = contentInput.value.trim();
            const newReward = rewardInput.value.trim();

            if (!newText) {
                alert("ìˆ˜ì •í•  ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }
            if (newReward === "" || isNaN(newReward)) {
                alert("ìœ íš¨í•œ ì ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }
            const item = currentEditItem;
            const missionId = item.dataset.id;
            const textSpan = item.querySelector(".mission-text");

            fetch("/update_mission", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id: missionId, content: newText, reward: Number(newReward) }),
            })
            .then(res => res.json())
            .then(result => {
                if (result.success) {
                    textSpan.textContent = `${newText} (${newReward}ì )`;
                    document.getElementById("toggleMissionSettingsBtn").click(); // ì„¤ì • ë²„íŠ¼ ìë™ ë‹«ê¸°
                    closeModal("modal7");
                } else {
                    alert("ìˆ˜ì • ì‹¤íŒ¨");
                }
            });
        }

        function confirmEditEnter(event) {
          if (event.key === "Enter") {
            const input = event.target;
            if (input.id === "editScoreInput") {
            confirmEdit(); // ì ìˆ˜ ìˆ˜ì •ìš©
            } 
            else if (input.id === "editRewardInput") {
            confirmMissionEdit(); // ë¯¸ì…˜ ë³´ìƒ ìˆ˜ì •ìš©
            }
          }            
        }
        function moveToEditScoreEnter(event) {
          if (event.key === "Enter") {
            if (event.target.id === "editRuleInput") {
                event.preventDefault(); // í¼ ì œì¶œ ë°©ì§€
                document.getElementById("editScoreInput").focus(); // ì ìˆ˜ ì…ë ¥ì¹¸ìœ¼ë¡œ ì´ë™
                return;
            }
            else if (event.target.id === "editMissionInput") {
                event.preventDefault(); // í¼ ì œì¶œ ë°©ì§€
                document.getElementById("editRewardInput").focus(); // ì ìˆ˜ ì…ë ¥ì¹¸ìœ¼ë¡œ ì´ë™
                return;
            }
          }
        }
        function submitRuleEnter(event) {//htmlê³¼ ì—°ê²°í•  í•¨ìˆ˜
          if (event.key === "Enter") {
            submitRule(
                document.getElementById("newRuleInput"),
                document.getElementById("newScoreInput")
            );
          }
        }

        function submitMissionEnter(event) {//htmlê³¼ ì—°ê²°í•  í•¨ìˆ˜
          if (event.key === "Enter") {
            submitMission(
                document.getElementById("newMissionInput"),
                document.getElementById("newRewardInput")
            );
          }
        }

        function moveToScoreEnter(event) {
          if (event.key === "Enter") {
            if (event.target.id === "newRuleInput") {
                event.preventDefault(); // í¼ ì œì¶œ ë°©ì§€
                document.getElementById("newScoreInput").focus(); // ì ìˆ˜ ì…ë ¥ì¹¸ìœ¼ë¡œ ì´ë™
                return;
            }
            else if (event.target.id === "newMissionInput") {
                event.preventDefault(); // í¼ ì œì¶œ ë°©ì§€
                document.getElementById("newRewardInput").focus(); // ì ìˆ˜ ì…ë ¥ì¹¸ìœ¼ë¡œ ì´ë™
                return;
            }
          }
        }

        function handleRuleAddButtonClick() {//htmlê³¼ ì—°ê²°í•  í•¨ìˆ˜
            submitRule(
                document.getElementById("newRuleInput"),
                document.getElementById("newScoreInput")
            );
        }

        function handleMissionAddButtonClick() {//htmlê³¼ ì—°ê²°í•  í•¨ìˆ˜
            submitMission(
                document.getElementById("newMissionInput"),
                document.getElementById("newRewardInput")
            );
        }

        //ê·œì¹™ ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜
		function loadRules() {
  			fetch("/get_rules")
    		.then(res => res.json())
    		.then(ruleList => {
      		const ruleUl = document.getElementById("ruleList");
      		ruleUl.innerHTML = ""; // ê¸°ì¡´ ê·œì¹™ ì´ˆê¸°í™”
      		ruleList.forEach(rule => {
        		const li = document.createElement("li");
                li.dataset.id = rule._id;

                const textSpan = document.createElement('span');
                textSpan.className = 'rule-text';
                textSpan.textContent = `${rule.content} (${rule.score}ì )`;

        		li.appendChild(textSpan);
        		ruleUl.appendChild(li);
      		});
    		});
		}
        //ë¯¸ì…˜ ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜
        function loadMissions() { // username: ë¡œê·¸ì¸ ìœ ì € ì´ë¦„
            fetch("/get_missions")
            .then(res => res.json())
            .then(missionList => {
                const missionUl = document.getElementById("missionList");
                missionUl.innerHTML = ""; // ê¸°ì¡´ ë¯¸ì…˜ ì´ˆê¸°í™”

                missionList.forEach(mission => {
                    const li = document.createElement("li");
                    li.dataset.id = mission._id;

                    // ë¯¸ì…˜ í…ìŠ¤íŠ¸
                    const textSpan = document.createElement('span');
                    textSpan.className = 'mission-text';
                    textSpan.textContent = `${mission.content} (${mission.reward}ì )`;
                    li.appendChild(textSpan);

                    // ì²´í¬ë°•ìŠ¤ ì¶”ê°€
                    const checkbox = document.createElement("input");
                    checkbox.type = "checkbox";
                    checkbox.className = "mission-check";
                    checkbox.dataset.missionId = mission._id;

                    // DBì˜ checked ë°°ì—´ì— usernameì´ ìˆìœ¼ë©´ ì²´í¬
                    if (mission.checked && mission.checked.includes("{{ username }}")) {
                        checkbox.checked = true;
                    }
                    checkbox.addEventListener("change", async function () {
                        const isChecked = checkbox.checked;

                        // ì„œë²„ì— ì²´í¬ ìƒíƒœ ì „ì†¡
                        if ("{{username}}" !== "{{room_name}}") {// ìœ ì €ë§Œ ì„œë²„ ì „ì†¡ ê°€ëŠ¥          
                        const response = await fetch("/update_checked", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                mission_id: mission._id,
                                username: "{{ username }}",
                                checked: isChecked,
                                admin: "{{ room_name }}"
                            }),
                        });
                        }
                    });

                    li.appendChild(checkbox);
                    missionUl.appendChild(li);
                });
            });
        }


        
        document.addEventListener('DOMContentLoaded', function () {//ì›¹í˜ì´ì§€ì— HTMLì´ ì™„ì„±ë˜ê³  DOM íŠ¸ë¦¬ê±°ê°€ ì™„ì„±ëœ ì´ë²¤íŠ¸
            var dropArea = document.querySelector('body');

            if (!dropArea) {
                console.error('Drop area not found');
                return;
            }

            function preventDefaults(e) {
                e.preventDefault();//ê¸°ë³¸ë™ì‘ ë°©ì§€(ìƒˆ í…ì— ì—¬ëŠ” ë™ì‘)
                e.stopPropagation();//ì´ë²¤íŠ¸ë²„ë¸”ë§ë°©ì§€
            }

            function highlight(e) {
                dropArea.classList.add('drag-over');//dropAreaìš”ì†Œì— drag-over CSSí´ë˜ìŠ¤ ì¶”ê°€í•˜ëŠ” ì½”ë“œì„
            }

            function unhighlight(e) {
                dropArea.classList.remove('drag-over');
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);//íŒŒì¼ì„ ëŒì–´ì˜¤ë©´(ë‘ ë¦¬ìŠ¤íŠ¸ ì´ë²¤íŠ¸) dropAreaì˜ í´ë˜ìŠ¤ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€ë˜ì–´ CSSìŠ¤íƒ€ì¼ì´ ì ìš©ë¨
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });

        });

    </script>

</body>

</html>